<!doctype html><html lang="zh-hans"><meta charset="utf-8"><title>useSyncExternalStore</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="usesyncexternalstore"><h1 id="usesyncexternalstore">useSyncExternalStore</h1><intro><p><code>useSyncExternalStore</code> æ˜¯ä¸€ä¸ªè®©ä½ è®¢é˜…å¤–éƒ¨ store çš„ React Hookã€‚<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> snapshot <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">,</span> getServerSnapshot<span class="token operator">?</span><span class="token punctuation">)</span></code></pre></intro><inlinetoc><section class="level2"aria-labelledby="å‚è€ƒ-reference"><h2 id="å‚è€ƒ-reference">å‚è€ƒ {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="usesyncexternalstoresubscribe-getsnapshot-getserversnapshot-usesyncexternalstore"><h3 id="usesyncexternalstoresubscribe-getsnapshot-getserversnapshot-usesyncexternalstore"><code>useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot?)</code> {/<em>usesyncexternalstore</em>/}</h3><p>åœ¨ç»„ä»¶é¡¶å±‚è°ƒç”¨ <code>useSyncExternalStore</code> ä»¥ä»å¤–éƒ¨ store è¯»å–å€¼ã€‚<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> todosStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./todoStore.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TodosApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>todosStore<span class="token punctuation">.</span><span class="token property-access">subscribe</span><span class="token punctuation">,</span> todosStore<span class="token punctuation">.</span><span class="token property-access">getSnapshot</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>å®ƒè¿”å› store ä¸­æ•°æ®çš„å¿«ç…§ã€‚ä½ éœ€è¦ä¼ ä¸¤ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼š<ol><li><code>subscribe</code> å‡½æ•°åº”å½“è®¢é˜…è¯¥ store å¹¶è¿”å›ä¸€ä¸ªå–æ¶ˆè®¢é˜…çš„å‡½æ•°ã€‚<li><code>getSnapshot</code> å‡½æ•°åº”å½“ä»è¯¥ store è¯»å–æ•°æ®çš„å¿«ç…§ã€‚</ol><p><a href="#usage">è¯·æŸ¥çœ‹ä¸‹é¢æ›´å¤šçš„ä¾‹å­</a>ã€‚<section class="level4"aria-labelledby="å‚æ•°-parameters"><h4 id="å‚æ•°-parameters">å‚æ•° {/<em>parameters</em>/}</h4><ul><li><p><code>subscribe</code>ï¼šä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªå•ç‹¬çš„ <code>callback</code> å‚æ•°å¹¶æŠŠå®ƒè®¢é˜…åˆ° store ä¸Šã€‚å½“ store å‘ç”Ÿæ”¹å˜ï¼Œå®ƒåº”å½“è°ƒç”¨è¢«æä¾›çš„ <code>callback</code>ã€‚è¿™ä¼šå¯¼è‡´ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚<code>subscribe</code> å‡½æ•°ä¼šè¿”å›æ¸…é™¤è®¢é˜…çš„å‡½æ•°ã€‚<li><p><code>getSnapshot</code>ï¼šä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›ç»„ä»¶éœ€è¦çš„ store ä¸­çš„æ•°æ®å¿«ç…§ã€‚åœ¨ store ä¸å˜çš„æƒ…å†µä¸‹ï¼Œé‡å¤è°ƒç”¨ <code>getSnapshot</code> å¿…é¡»è¿”å›åŒä¸€ä¸ªå€¼ã€‚å¦‚æœ store æ”¹å˜ï¼Œå¹¶ä¸”è¿”å›å€¼ä¹Ÿä¸åŒäº†ï¼ˆç”¨ <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is"><code>Object.is</code></a> æ¯”è¾ƒï¼‰ï¼ŒReact å°±ä¼šé‡æ–°æ¸²æŸ“ç»„ä»¶ã€‚<li><p><strong>å¯é€‰</strong> <code>getServerSnapshot</code>ï¼šä¸€ä¸ªå‡½æ•°ï¼Œè¿”å› store ä¸­æ•°æ®çš„åˆå§‹å¿«ç…§ã€‚å®ƒåªä¼šåœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼Œä»¥åŠåœ¨å®¢æˆ·ç«¯è¿›è¡ŒæœåŠ¡ç«¯æ¸²æŸ“å†…å®¹çš„ hydration æ—¶è¢«ç”¨åˆ°ã€‚å¿«ç…§åœ¨æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä¹‹é—´å¿…é¡»ç›¸åŒï¼Œå®ƒé€šå¸¸æ˜¯ä»æœåŠ¡ç«¯åºåˆ—åŒ–å¹¶ä¼ åˆ°å®¢æˆ·ç«¯çš„ã€‚å¦‚æœä½ å¿½ç•¥æ­¤å‚æ•°ï¼Œåœ¨æœåŠ¡ç«¯æ¸²æŸ“è¿™ä¸ªç»„ä»¶ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚</ul></section><section class="level4"aria-labelledby="è¿”å›å€¼-returns"><h4 id="è¿”å›å€¼-returns">è¿”å›å€¼ {/<em>returns</em>/}</h4><p>è¯¥ store çš„å½“å‰å¿«ç…§ï¼Œå¯ä»¥åœ¨ä½ çš„æ¸²æŸ“é€»è¾‘ä¸­ä½¿ç”¨ã€‚</section><section class="level4"aria-labelledby="è­¦å‘Š-caveats"><h4 id="è­¦å‘Š-caveats">è­¦å‘Š {/<em>caveats</em>/}</h4><ul><li><p><code>getSnapshot</code> è¿”å›çš„ store å¿«ç…§å¿…é¡»æ˜¯ä¸å¯å˜çš„ã€‚å¦‚æœåº•å±‚ store æœ‰å¯å˜æ•°æ®ï¼Œè¦åœ¨æ•°æ®æ”¹å˜æ—¶è¿”å›ä¸€ä¸ªæ–°çš„ä¸å¯å˜å¿«ç…§ã€‚å¦åˆ™ï¼Œè¿”å›ä¸Šæ¬¡ç¼“å­˜çš„å¿«ç…§ã€‚<li><p>å¦‚æœåœ¨é‡æ–°æ¸²æŸ“æ—¶ä¼ å…¥ä¸€ä¸ªä¸åŒçš„ <code>subscribe</code> å‡½æ•°ï¼ŒReact ä¼šç”¨æ–°ä¼ å…¥çš„ <code>subscribe</code> å‡½æ•°é‡æ–°è®¢é˜…è¯¥ storeã€‚ä½ å¯ä»¥é€šè¿‡åœ¨ç»„ä»¶å¤–å£°æ˜ <code>subscribe</code> æ¥é¿å…ã€‚</ul></section></section></section><section class="level2"aria-labelledby="ä½¿ç”¨-usage"><h2 id="ä½¿ç”¨-usage">ä½¿ç”¨ {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="è®¢é˜…å¤–éƒ¨-store-subscribing-to-an-external-store"><h3 id="è®¢é˜…å¤–éƒ¨-store-subscribing-to-an-external-store">è®¢é˜…å¤–éƒ¨ store {/<em>subscribing-to-an-external-store</em>/}</h3><p>ä½ çš„å¤šæ•°ç»„ä»¶åªä¼šä»å®ƒä»¬çš„ <a href="/learn/passing-props-to-a-component">props</a>ï¼Œ<a href="/reference/react/useState">state</a>ï¼Œä»¥åŠ <a href="/reference/react/useContext">context</a> è¯»å–æ•°æ®ã€‚ç„¶è€Œï¼Œæœ‰æ—¶ä¸€ä¸ªç»„ä»¶éœ€è¦ä»ä¸€äº› React ä¹‹å¤–çš„ store è¯»å–ä¸€äº›éšæ—¶é—´å˜åŒ–çš„æ•°æ®ã€‚è¿™åŒ…æ‹¬ï¼š<ul><li>åœ¨ React ä¹‹å¤–æŒæœ‰çŠ¶æ€çš„ç¬¬ä¸‰æ–¹çŠ¶æ€ç®¡ç†åº“<li>æš´éœ²å‡ºä¸€ä¸ªå¯å˜å€¼åŠè®¢é˜…å…¶æ”¹å˜äº‹ä»¶çš„æµè§ˆå™¨ API</ul><p>åœ¨ç»„ä»¶é¡¶å±‚è°ƒç”¨ <code>useSyncExternalStore</code> ä»¥ä»å¤–éƒ¨ store è¯»å–å€¼ã€‚<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> todosStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./todoStore.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TodosApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>todosStore<span class="token punctuation">.</span><span class="token property-access">subscribe</span><span class="token punctuation">,</span> todosStore<span class="token punctuation">.</span><span class="token property-access">getSnapshot</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>å®ƒè¿”å› store ä¸­æ•°æ®çš„<codestep step="{3}">å¿«ç…§</codestep>ã€‚ä½ éœ€è¦ä¼ ä¸¤ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼š<ol><li><codestep step="{1}"><code>subscribe</code> å‡½æ•°</codestep>åº”å½“è®¢é˜… store å¹¶è¿”å›ä¸€ä¸ªå–æ¶ˆè®¢é˜…å‡½æ•°ã€‚<li><codestep step="{2}"><code>getSnapshot</code> å‡½æ•°</codestep>åº”å½“ä» store ä¸­è¯»å–æ•°æ®çš„å¿«ç…§ã€‚</ol><p>React ä¼šç”¨è¿™äº›å‡½æ•°æ¥ä¿æŒä½ çš„ç»„ä»¶è®¢é˜…åˆ° store å¹¶åœ¨å®ƒæ”¹å˜æ—¶é‡æ–°æ¸²æŸ“ã€‚<p>ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢çš„æ²™ç›’ä¸­ï¼Œ<code>todosStore</code> è¢«å®ç°ä¸ºä¸€ä¸ªä¿å­˜ React ä¹‹å¤–æ•°æ®çš„å¤–éƒ¨ storeã€‚<code>TodosApp</code> ç»„ä»¶é€šè¿‡ <code>useSyncExternalStore</code> Hook è¿æ¥åˆ°å¤–éƒ¨ storeã€‚</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> todosStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./todoStore.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TodosApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>todosStore<span class="token punctuation">.</span><span class="token property-access">subscribe</span><span class="token punctuation">,</span> todosStore<span class="token punctuation">.</span><span class="token property-access">getSnapshot</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> todosStore<span class="token punctuation">.</span><span class="token method function property-access">addTodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Add</span> todo<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>ul<span class="token operator">></span>
        <span class="token punctuation">{</span>todos<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">todo</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>
          <span class="token operator">&#x3C;</span>li key<span class="token operator">=</span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span><span class="token property-access">text</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>li<span class="token operator">></span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>ul<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// è¿™æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹ store çš„ä¾‹å­ï¼Œ</span>
<span class="token comment">// ä½ å¯èƒ½éœ€è¦æŠŠå®ƒä¸ React é›†æˆã€‚</span>

<span class="token comment">// å¦‚æœä½ çš„åº”ç”¨å®Œå…¨ç”± React æ„å»ºï¼Œ</span>
<span class="token comment">// æˆ‘ä»¬æ¨èä½¿ç”¨ React state æ›¿ä»£ã€‚</span>

<span class="token keyword">let</span> nextId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> todosStore <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">addTodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>listeners<span class="token punctuation">,</span> listener<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      listeners <span class="token operator">=</span> listeners<span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token parameter">l</span> <span class="token arrow operator">=></span> l <span class="token operator">!==</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> todos<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">emitChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> listener <span class="token keyword">of</span> listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></sandpack><note><p>å½“å¯èƒ½çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ¨èé€šè¿‡ <a href="/reference/react/useState"><code>useState</code></a> å’Œ <a href="/reference/react/useReducer"><code>useReducer</code></a> ä½¿ç”¨å†…å»ºçš„ React state ä»£æ›¿ã€‚å¦‚æœä½ éœ€è¦å»é›†æˆå·²æœ‰çš„é React ä»£ç ï¼Œ<code>useSyncExternalStore</code> API æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚</p></note></section><section class="level3"aria-labelledby="è®¢é˜…æµè§ˆå™¨-api-subscribing-to-a-browser-api"><h3 id="è®¢é˜…æµè§ˆå™¨-api-subscribing-to-a-browser-api">è®¢é˜…æµè§ˆå™¨ API {/<em>subscribing-to-a-browser-api</em>/}</h3><p>æ·»åŠ  <code>useSyncExternalStore</code> çš„å¦ä¸€ä¸ªåœºæ™¯æ˜¯å½“ä½ æƒ³è®¢é˜…ä¸€äº›ç”±æµè§ˆå™¨æš´éœ²çš„å¹¶éšæ—¶é—´å˜åŒ–çš„å€¼æ—¶ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä½ æƒ³è¦ç»„ä»¶å±•ç¤ºç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ã€‚æµè§ˆå™¨é€šè¿‡ä¸€ä¸ªå«åš <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/onLine"><code>navigator.onLine</code></a> çš„å±æ€§æš´éœ²å‡ºè¿™ä¸€ä¿¡æ¯ã€‚<p>è¿™ä¸ªå€¼å¯èƒ½åœ¨ React ä¸çŸ¥é“çš„æƒ…å†µä¸‹æ”¹å˜ï¼Œæ‰€ä»¥ä½ åº”å½“é€šè¿‡ <code>useSyncExternalStore</code> æ¥è¯»å–å®ƒã€‚<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>ä»æµè§ˆå™¨ API è¯»å–å½“å‰å€¼ï¼Œæ¥å®ç° <code>getSnapshot</code> å‡½æ•°ï¼š<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>æ¥ä¸‹æ¥ï¼Œä½ éœ€è¦å®ç° <code>subscribe</code> å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œå½“ <code>navigator.onLine</code> æ”¹å˜ï¼Œæµè§ˆå™¨è§¦å‘ <code>window</code> å¯¹è±¡çš„ <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/online_event"><code>online</code></a> å’Œ <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/offline_event"><code>offline</code></a> äº‹ä»¶ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ¸…é™¤è®¢é˜…çš„å‡½æ•°ï¼š<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>ç°åœ¨ React çŸ¥é“å¦‚ä½•ä»å¤–éƒ¨çš„ <code>navigator.onLine</code> API è¯»åˆ°è¿™ä¸ªå€¼ï¼Œä»¥åŠå¦‚ä½•è®¢é˜…å…¶æ”¹å˜ã€‚æ–­å¼€ä½ çš„è®¾å¤‡çš„ç½‘ç»œï¼Œå°±å¯ä»¥è§‚å¯Ÿåˆ°ç»„ä»¶é‡æ–°æ¸²æŸ“äº†ï¼š</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>isOnline <span class="token operator">?</span> <span class="token string">'âœ… Online'</span> <span class="token operator">:</span> <span class="token string">'âŒ Disconnected'</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack></section><section class="level3"aria-labelledby="æŠŠé€»è¾‘æŠ½å–åˆ°è‡ªå®šä¹‰-hook-extracting-the-logic-to-a-custom-hook"><h3 id="æŠŠé€»è¾‘æŠ½å–åˆ°è‡ªå®šä¹‰-hook-extracting-the-logic-to-a-custom-hook">æŠŠé€»è¾‘æŠ½å–åˆ°è‡ªå®šä¹‰ Hook {/<em>extracting-the-logic-to-a-custom-hook</em>/}</h3><p>é€šå¸¸ä¸ä¼šåœ¨ç»„ä»¶é‡Œç›´æ¥ç”¨ <code>useSyncExternalStore</code>ï¼Œè€Œæ˜¯åœ¨è‡ªå®šä¹‰ Hook é‡Œè°ƒç”¨å®ƒã€‚è¿™ä½¿å¾—ä½ å¯ä»¥åœ¨ä¸åŒç»„ä»¶é‡Œä½¿ç”¨ç›¸åŒçš„å¤–éƒ¨ storeã€‚<p>ä¾‹å¦‚ï¼šè¿™é‡Œè‡ªå®šä¹‰çš„ <code>useOnlineStatus</code> Hook è¿½è¸ªç½‘ç»œæ˜¯å¦åœ¨çº¿ï¼š<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> isOnline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>ç°åœ¨ä¸åŒçš„ç»„ä»¶éƒ½å¯ä»¥è°ƒç”¨ <code>useOnlineStatus</code>ï¼Œè€Œä¸å¿…é‡å¤åº•å±‚å®ç°ï¼š</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useOnlineStatus <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./useOnlineStatus.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">StatusBar</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>isOnline <span class="token operator">?</span> <span class="token string">'âœ… Online'</span> <span class="token operator">:</span> <span class="token string">'âŒ Disconnected'</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">SaveButton</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleSaveClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'âœ… Progress saved'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button disabled<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">!</span>isOnline<span class="token punctuation">}</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSaveClick<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>isOnline <span class="token operator">?</span> <span class="token string">'Save progress'</span> <span class="token operator">:</span> <span class="token string">'Reconnecting...'</span><span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">SaveButton</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">StatusBar</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> isOnline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack></section><section class="level3"aria-labelledby="æ·»åŠ æœåŠ¡ç«¯æ¸²æŸ“æ”¯æŒ-adding-support-for-server-rendering"><h3 id="æ·»åŠ æœåŠ¡ç«¯æ¸²æŸ“æ”¯æŒ-adding-support-for-server-rendering">æ·»åŠ æœåŠ¡ç«¯æ¸²æŸ“æ”¯æŒ {/<em>adding-support-for-server-rendering</em>/}</h3><p>å¦‚æœä½ çš„ React åº”ç”¨ä½¿ç”¨ <a href="/reference/react-dom/server">æœåŠ¡ç«¯æ¸²æŸ“</a>ï¼Œä½ çš„ React ç»„ä»¶ä¹Ÿä¼šè¿è¡Œåœ¨æµè§ˆå™¨ç¯å¢ƒä¹‹å¤–æ¥ç”Ÿæˆåˆå§‹ HTMLã€‚è¿™ç»™è¿æ¥åˆ°å¤–éƒ¨ store é€ æˆäº†ä¸€äº›æŒ‘æˆ˜ï¼š<ul><li>å¦‚æœä½ è¿æ¥åˆ°ä¸€ä¸ªæµè§ˆå™¨ç‰¹æœ‰çš„ APIï¼Œå› ä¸ºå®ƒåœ¨æœåŠ¡ç«¯ä¸å­˜åœ¨ï¼Œæ‰€ä»¥æ˜¯ä¸å¯è¡Œçš„ã€‚<li>å¦‚æœä½ è¿æ¥åˆ°ä¸€ä¸ªç¬¬ä¸‰æ–¹ storeï¼Œæ•°æ®è¦åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´ç›¸åŒ¹é…ã€‚</ul><p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œè¦ä¼ ä¸€ä¸ª <code>getServerSnapshot</code> å‡½æ•°ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ç»™ <code>useSyncExternalStore</code>ï¼š<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">,</span> getServerSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> isOnline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getServerSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// æœåŠ¡ç«¯ç”Ÿæˆçš„ HTML æ€»æ˜¯æ˜¾ç¤ºâ€œåœ¨çº¿â€</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p><code>getServerSnapshot</code> å‡½æ•°ä¸ <code>getSnapshot</code> ç›¸ä¼¼ï¼Œä½†å®ƒåªåœ¨ä¸¤ç§æƒ…å†µä¸‹æ‰è¿è¡Œï¼š<ul><li>åœ¨æœåŠ¡ç«¯ç”Ÿæˆ HTML æ—¶ã€‚<li>åœ¨å®¢æˆ·ç«¯ <a href="/reference/react-dom/client/hydrateRoot">hydration</a> æ—¶ï¼Œå³ï¼šå½“ React æ‹¿åˆ°æœåŠ¡ç«¯çš„ HTML å¹¶ä½¿å…¶å¯äº¤äº’ã€‚</ul><p>è¿™ä½¿å¾—ä½ èƒ½æä¾›åœ¨åº”ç”¨å¯äº¤äº’å‰å¯ç”¨çš„åˆå§‹å¿«ç…§å€¼ã€‚å¦‚æœæ²¡æœ‰å¯¹æœåŠ¡å™¨ç«¯æ¸²æŸ“æ¥è¯´æœ‰æ„ä¹‰çš„åˆå§‹å€¼ï¼Œå°±çœç•¥è¿™ä¸ªå‚æ•°æ¥ <a href="/reference/react/Suspense#providing-a-fallback-for-server-errors-and-server-only-content">å¼ºåˆ¶å®¢æˆ·ç«¯æ¸²æŸ“</a>ã€‚</p><note><p>ç¡®ä¿å®¢æˆ·ç«¯åˆå§‹æ¸²æŸ“ä¸æœåŠ¡ç«¯æ¸²æŸ“æ—¶ <code>getServerSnapshot</code> è¿”å›å®Œå…¨ç›¸åŒçš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåœ¨æœåŠ¡ç«¯ <code>getServerSnapshot</code> è¿”å›ä¸€äº›é¢„å…ˆè½½å…¥çš„ store å†…å®¹ï¼Œä½ å°±éœ€è¦æŠŠè¿™äº›å†…å®¹ä¹Ÿä¼ ç»™å®¢æˆ·ç«¯ã€‚ä¸€ç§æ–¹æ³•æ˜¯åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼Œç”Ÿæˆ <code>&#x3C;script></code> æ ‡ç­¾æ¥è®¾ç½®åƒ <code>window.MY_STORE_DATA</code> è¿™æ ·çš„å…¨å±€å˜é‡ï¼Œå¹¶åœ¨å®¢æˆ·ç«¯ <code>getServerSnapshot</code> å†…è¯»å–æ­¤å…¨å±€å˜é‡ã€‚ä½ çš„å¤–éƒ¨ store åº”å½“æä¾›å¦‚ä½•è¿™æ ·åšçš„è¯´æ˜ã€‚</p></note></section></section><section class="level2"aria-labelledby="ç–‘éš¾è§£ç­”-troubleshooting"><h2 id="ç–‘éš¾è§£ç­”-troubleshooting">ç–‘éš¾è§£ç­” {/<em>troubleshooting</em>/}</h2><section class="level3"aria-labelledby="é‡åˆ°ä¸€ä¸ªé”™è¯¯the-result-of-getsnapshot-should-be-cached-im-getting-an-error-the-result-of-getsnapshot-should-be-cached"><h3 id="é‡åˆ°ä¸€ä¸ªé”™è¯¯the-result-of-getsnapshot-should-be-cached-im-getting-an-error-the-result-of-getsnapshot-should-be-cached">é‡åˆ°ä¸€ä¸ªé”™è¯¯ï¼šâ€œThe result of <code>getSnapshot</code> should be cachedâ€ {/<em>im-getting-an-error-the-result-of-getsnapshot-should-be-cached</em>/}</h3><p>è¿™ä¸ªé”™è¯¯æ„å‘³ç€ä½ çš„ <code>getSnapshot</code> å‡½æ•°æ¯æ¬¡è°ƒç”¨éƒ½è¿”å›äº†ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œä¾‹å¦‚ï¼š<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ğŸ”´ getSnapshot ä¸è¦æ€»æ˜¯è¿”å›ä¸åŒçš„å¯¹è±¡</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">todos</span><span class="token operator">:</span> myStore<span class="token punctuation">.</span><span class="token property-access">todos</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>å¦‚æœ <code>getSnapshot</code> è¿”å›å€¼ä¸åŒäºä¸Šä¸€æ¬¡ï¼ŒReact ä¼šé‡æ–°æ¸²æŸ“ç»„ä»¶ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆï¼Œå¦‚æœæ€»æ˜¯è¿”å›ä¸€ä¸ªä¸åŒçš„å€¼ï¼Œä¼šè¿›å…¥åˆ°ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå¹¶äº§ç”Ÿè¿™ä¸ªæŠ¥é”™ã€‚<p>åªæœ‰å½“ç¡®å®æœ‰ä¸œè¥¿æ”¹å˜äº†ï¼Œ<code>getSnapshot</code> æ‰åº”è¯¥è¿”å›ä¸€ä¸ªä¸åŒçš„å¯¹è±¡ã€‚å¦‚æœä½ çš„ store åŒ…å«ä¸å¯å˜æ•°æ®ï¼Œå¯ä»¥ç›´æ¥è¿”å›æ­¤æ•°æ®ï¼š<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// âœ… ä½ å¯ä»¥è¿”å›ä¸å¯å˜æ•°æ®</span>
  <span class="token keyword control-flow">return</span> myStore<span class="token punctuation">.</span><span class="token property-access">todos</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>å¦‚æœä½ çš„ store æ•°æ®æ˜¯å¯å˜çš„ï¼Œ<code>getSnapshot</code> å‡½æ•°åº”å½“è¿”å›ä¸€ä¸ªå®ƒçš„ä¸å¯å˜å¿«ç…§ã€‚è¿™æ„å‘³ç€ <strong>ç¡®å®</strong> éœ€è¦åˆ›å»ºæ–°å¯¹è±¡ï¼Œä½†ä¸æ˜¯æ¯æ¬¡è°ƒç”¨éƒ½å¦‚æ­¤ã€‚è€Œæ˜¯åº”å½“ä¿å­˜æœ€åä¸€æ¬¡è®¡ç®—å¾—åˆ°çš„å¿«ç…§ï¼Œå¹¶ä¸”åœ¨ store ä¸­çš„æ•°æ®ä¸å˜çš„æƒ…å†µä¸‹ï¼Œè¿”å›ä¸ä¸Šä¸€æ¬¡ç›¸åŒçš„å¿«ç…§ã€‚å¦‚ä½•å†³å®šå¯å˜æ•°æ®å‘ç”Ÿäº†æ”¹å˜åˆ™å–å†³äºä½ çš„å¯å˜ storeã€‚</section><section class="level3"aria-labelledby="æˆ‘çš„-subscribe-å‡½æ•°æ¯æ¬¡é‡æ–°æ¸²æŸ“éƒ½è¢«è°ƒç”¨-my-subscribe-function-gets-called-after-every-re-render"><h3 id="æˆ‘çš„-subscribe-å‡½æ•°æ¯æ¬¡é‡æ–°æ¸²æŸ“éƒ½è¢«è°ƒç”¨-my-subscribe-function-gets-called-after-every-re-render">æˆ‘çš„ <code>subscribe</code> å‡½æ•°æ¯æ¬¡é‡æ–°æ¸²æŸ“éƒ½è¢«è°ƒç”¨ {/<em>my-subscribe-function-gets-called-after-every-re-render</em>/}</h3><p>è¿™é‡Œçš„ <code>subscribe</code> å‡½æ•°æ˜¯åœ¨ç»„ä»¶ <strong>å†…éƒ¨</strong> å®šä¹‰çš„ï¼Œæ‰€ä»¥å®ƒæ¯æ¬¡æ¸²æŸ“éƒ½ä¸åŒï¼š<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// ğŸš© æ€»æ˜¯ä¸åŒçš„å‡½æ•°ï¼Œæ‰€ä»¥ React æ¯æ¬¡é‡æ–°æ¸²æŸ“éƒ½ä¼šé‡æ–°è®¢é˜…</span>
  <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>å¦‚æœé‡æ–°æ¸²æŸ“æ—¶ä½ ä¼ ä¸€ä¸ªä¸åŒçš„ <code>subscribe</code> å‡½æ•°ï¼ŒReact ä¼šé‡æ–°è®¢é˜…ä½ çš„ storeã€‚å¦‚æœè¿™é€ æˆäº†æ€§èƒ½é—®é¢˜ï¼Œå› è€Œä½ æƒ³é¿å…é‡æ–°è®¢é˜…ï¼Œå°±æŠŠ <code>subscribe</code> å‡½æ•°ç§»åˆ°å¤–é¢ï¼š<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// âœ… æ€»æ˜¯ç›¸åŒçš„å‡½æ•°ï¼Œæ‰€ä»¥ React ä¸éœ€è¦é‡æ–°è®¢é˜…</span>
<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>æˆ–è€…ï¼ŒæŠŠ <code>subscribe</code> åŒ…åœ¨ <a href="/reference/react/useCallback"><code>useCallback</code></a> é‡Œé¢ä»¥ä¾¿åªåœ¨æŸäº›å‚æ•°æ”¹å˜æ—¶é‡æ–°è®¢é˜…ï¼š<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> userId <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// âœ… åªè¦ userId ä¸å˜ï¼Œéƒ½æ˜¯åŒä¸€ä¸ªå‡½æ•°</span>
  <span class="token keyword">const</span> subscribe <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>userId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>