<!doctype html><html lang="fr"><meta charset="utf-8"><title>useSyncExternalStore</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="usesyncexternalstore"><h1 id="usesyncexternalstore">useSyncExternalStore</h1><intro><p><code>useSyncExternalStore</code> est un Hook React qui vous permet de vous abonner √† une source de donn√©es ext√©rieure.<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> snapshot <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">,</span> getServerSnapshot<span class="token operator">?</span><span class="token punctuation">)</span></code></pre></intro><inlinetoc><section class="level2"aria-labelledby="r√©f√©rence-reference"><h2 id="r√©f√©rence-reference">R√©f√©rence {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="usesyncexternalstoresubscribe-getsnapshot-getserversnapshot-usesyncexternalstore"><h3 id="usesyncexternalstoresubscribe-getsnapshot-getserversnapshot-usesyncexternalstore"><code>useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot?)</code> {/<em>usesyncexternalstore</em>/}</h3><p>Appelez <code>useSyncExternalStore</code> √† la racine de votre composant pour lire une valeur provenant d'une source de donn√©es ext√©rieure.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> todosStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./todoStore.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TodosApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>todosStore<span class="token punctuation">.</span><span class="token property-access">subscribe</span><span class="token punctuation">,</span> todosStore<span class="token punctuation">.</span><span class="token property-access">getSnapshot</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Il renvoie un instantan√© de cette donn√©e issue de la source. Vous aurez besoin de passer deux fonctions comme arguments¬†:<ol><li>La fonction <code>subscribe</code> est cens√©e s'abonner √† la source et renvoyer une fonction de d√©sabonnement.<li>La fonction <code>getSnapshot</code> est cens√©e lire un instantan√© de la donn√©e souhait√©e au sein de la source.</ol><p><a href="#usage">Voir d'autres exemples ci-dessous</a>.<section class="level4"aria-labelledby="param√®tres-parameters"><h4 id="param√®tres-parameters">Param√®tres {/<em>parameters</em>/}</h4><ul><li><p><code>subscribe</code>¬†: une fonction acceptant un unique argument <code>callback</code> qui s'abonne √† la source de donn√©es. Lorsque la source √©volue, elle est cens√©e invoquer <code>callback</code>. √áa permettra au composant de refaire un rendu. La fonction <code>subscribe</code> est cens√©e renvoyer une fonction qui proc√®de au d√©sabonnement associ√©.<li><p><code>getSnapshot</code>¬†: une fonction qui renvoie un instantan√© de la donn√©e requise par le composant au sein de la source. Tant que la source n'√©volue pas, des appels r√©p√©t√©s √† <code>getSnapshot</code> sont cens√©s renvoyer la m√™me valeur. Si la source √©volue et que la valeur renvoy√©e diff√®re soudain (en comparant √† l'aide de <a href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object/is"><code>Object.is</code></a>), React refait un rendu du composant.<li><p><code>getServerSnapshot</code> <strong>optionnelle</strong>¬†: une fonction qui renvoie un premier instantan√© de la donn√©e au sein de la source. Elle ne sera utilis√©e que pour le rendu c√¥t√© serveur, et pendant la phase d'hydratation du contenu fourni par le serveur une fois c√¥t√© client. L'instantan√© serveur doit √™tre identique qu'il soit ex√©cut√© c√¥t√© serveur ou c√¥t√© client¬†: il est donc g√©n√©ralement s√©rialis√© et pass√© du serveur au client. Si vous omettez cet argument, toute tentative de rendu c√¥t√© serveur de votre composant l√®vera une erreur.</ul></section><section class="level4"aria-labelledby="valeur-renvoy√©e-returns"><h4 id="valeur-renvoy√©e-returns">Valeur renvoy√©e {/<em>returns</em>/}</h4><p>L'instantan√© actuel de la valeur issue de la source, que vous pouvez utiliser pour votre logique de rendu.</section><section class="level4"aria-labelledby="limitations-caveats"><h4 id="limitations-caveats">Limitations {/<em>caveats</em>/}</h4><ul><li><p>L'instantan√© de la source renvoy√© par <code>getSnapshot</code> doit √™tre immuable. Si la source de donn√©es sous-jacente a des donn√©es modifiables, renvoyez une copie immuable comme instantan√© lorsque la donn√©e change. √Ä d√©faut, renvoyez une version mise en cache de l'instantan√© pr√©c√©dent.<li><p>Si une fonction <code>subscribe</code> diff√©rente est pass√©e lors d'un nouveau rendu, React se r√©abonnera √† la source de donn√©es en utilisant cette nouvelle fonction <code>subscribe</code>. Vous pouvez √©viter √ßa en d√©clarant <code>subscribe</code> hors du composant.</ul></section></section></section><section class="level2"aria-labelledby="utilisation-usage"><h2 id="utilisation-usage">Utilisation {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="sabonner-√†-une-source-de-donn√©es-ext√©rieure-subscribing-to-an-external-store"><h3 id="sabonner-√†-une-source-de-donn√©es-ext√©rieure-subscribing-to-an-external-store">S'abonner √† une source de donn√©es ext√©rieure {/<em>subscribing-to-an-external-store</em>/}</h3><p>La plupart des composants React n'ont besoin de lire des donn√©es que depuis leurs <a href="/learn/passing-props-to-a-component">props</a>, leur <a href="/reference/react/useState">√©tat</a> et leur <a href="/reference/react/useContext">contexte</a>. N√©anmoins, il arrive parfois qu'un composant ait besoin de lire des donn√©es dont la source est ext√©rieure √† React, donn√©es qui √©voluent avec le temps. √áa inclut notamment¬†:<ul><li>Les biblioth√®ques tierces de gestion d'√©tat applicatif, qui stockent leur √©tat hors de React.<li>Les API navigateur qui exposent une valeur modifiable et des √©v√©nements pour s'abonner √† ses modifications.</ul><p>Appelez <code>useSyncExternalStore</code> √† la racine de votre composant pour lire une valeur depuis une source de donn√©es ext√©rieure.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> todosStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./todoStore.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TodosApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>todosStore<span class="token punctuation">.</span><span class="token property-access">subscribe</span><span class="token punctuation">,</span> todosStore<span class="token punctuation">.</span><span class="token property-access">getSnapshot</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Elle renvoie un<codestep step="{3}">instantan√©</codestep>de la donn√©e issue de la source. Vous devrez lui passer deux arguments fonctions¬†:<ol><li>La fonction<codestep step="{1}"><code>subscribe</code></codestep>est cens√©e s'abonner √† la source et renvoyer une fonction de d√©sabonnement.<li>La fonction<codestep step="{2}"><code>getSnapshot</code></codestep>est cens√©e lire un instantan√© de la donn√©e souhait√©e au sein de la source.</ol><p>React utilisera ces fonctions pour garder votre composant abonn√© √† la source et refaire un rendu lorsque la donn√©e change.<p>Par exemple, dans le bac √† sable ci-dessous, <code>todosStore</code> est implement√© <em>via</em> une source de donn√©es ext√©rieure, dont l'√©tat est stock√© hors de React. Le composant <code>TodosApp</code> se connecte √† cette source ext√©rieure avec le Hook <code>useSyncExternalStore</code>.</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> todosStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./todoStore.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TodosApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>todosStore<span class="token punctuation">.</span><span class="token property-access">subscribe</span><span class="token punctuation">,</span> todosStore<span class="token punctuation">.</span><span class="token property-access">getSnapshot</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> todosStore<span class="token punctuation">.</span><span class="token method function property-access">addTodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Ajouter</span> une t√¢che<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>ul<span class="token operator">></span>
        <span class="token punctuation">{</span>todos<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">todo</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>
          <span class="token operator">&#x3C;</span>li key<span class="token operator">=</span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span><span class="token property-access">text</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>li<span class="token operator">></span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>ul<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// Voici un exemple de source de donn√©es tierce</span>
<span class="token comment">// que vous pourriez avoir besoin d'int√©grer dans React.</span>

<span class="token comment">// Si votre appli est int√©gralement construite avec</span>
<span class="token comment">// React, nous vous recommandons de plut√¥t utiliser</span>
<span class="token comment">// l'√©tat local React pour √ßa.</span>

<span class="token keyword">let</span> nextId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> todosStore <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">addTodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>listeners<span class="token punctuation">,</span> listener<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      listeners <span class="token operator">=</span> listeners<span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token parameter">l</span> <span class="token arrow operator">=></span> l <span class="token operator">!==</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> todos<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">emitChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> listener <span class="token keyword">of</span> listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></sandpack><note><p>Autant que possible, nous vous recommandons de plut√¥t utiliser l'√©tat local React avec <a href="/reference/react/useState"><code>useState</code></a> et <a href="/reference/react/useReducer"><code>useReducer</code></a>. L'API <code>useSyncExternalStore</code> est surtout utile pour vous int√©grer avec du code existant non bas√© sur React.</p></note></section><section class="level3"aria-labelledby="sabonner-√†-une-api-navigateur-subscribing-to-a-browser-api"><h3 id="sabonner-√†-une-api-navigateur-subscribing-to-a-browser-api">S'abonner √† une API navigateur {/<em>subscribing-to-a-browser-api</em>/}</h3><p><code>useSyncExternalStore</code> est √©galement bien utile pour vous abonner √† une valeur expos√©e par le navigateur et susceptible de changer au fil du temps. Supposez par exemple que vous souhaitiez que votre composant affiche l'√©tat actif ou non de la connexion r√©seau. Le navigateur expose cette information au travers d'une propri√©t√© <a href="https://developer.mozilla.org/docs/Web/API/Navigator/onLine"><code>navigator.onLine</code></a>.<p>Cette valeur peut changer sans que React le sache, vous devriez donc la lire avec <code>useSyncExternalStore</code>.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Pour impl√©menter la fonction <code>getSnapshot</code>, lisez la valeur actuelle <em>via</em> l'API navigateur¬†:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Vous devez ensuite impl√©menter la fonction <code>subscribe</code>. Il se trouve que lorsque <code>navigation.onLine</code> change, le navigateur d√©clenche l'√©v√©nement <a href="https://developer.mozilla.org/docs/Web/API/Window/online_event"><code>online</code></a> ou <a href="https://developer.mozilla.org/docs/Web/API/Window/offline_event"><code>offline</code></a> sur l'objet <code>window</code>. Vous devez abonner l'argument <code>callback</code> √† ces √©v√©nements, et renvoyer une fonction qui fait le d√©sabonnement correspondant¬†:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>√Ä pr√©sent React sait comment lire cette valeur depuis l'API ext√©rieure <code>navigation.onLine</code>, et comment s'abonner pour √™tre au courant de ses changements. D√©connectez votre appareil du r√©seau et remarquez que le composant r√©agit en se rafra√Æchissant¬†:<sandpack></sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>isOnline <span class="token operator">?</span> <span class="token string">'‚úÖ En ligne'</span> <span class="token operator">:</span> <span class="token string">'‚ùå D√©connect√©'</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section class="level3"aria-labelledby="extraire-la-logique-dans-un-hook-personnalis√©-extracting-the-logic-to-a-custom-hook"><h3 id="extraire-la-logique-dans-un-hook-personnalis√©-extracting-the-logic-to-a-custom-hook">Extraire la logique dans un Hook personnalis√© {/<em>extracting-the-logic-to-a-custom-hook</em>/}</h3><p>En temps normal vous n'appellerez pas <code>useSyncExternalStore</code> directement dans vos composants. Vous l'enroberez g√©n√©ralement plut√¥t dans votre propre Hook personnalis√©. √áa vous permet d'utiliser la m√™me source de donn√©es ext√©rieure depuis plusieurs composants.<p>Par exemple, ce Hook personnalis√© <code>useOnlineStatus</code> surveille l'√©tat connect√© ou non du r√©seau¬†:<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> isOnline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Gr√¢ce √† √ßa, plusieurs composants distincts peuvent utiliser <code>useOnlineStatus</code> sans avoir √† r√©p√©ter l'impl√©mentation sous-jacente¬†:</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useOnlineStatus <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./useOnlineStatus.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">StatusBar</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>isOnline <span class="token operator">?</span> <span class="token string">'‚úÖ En ligne'</span> <span class="token operator">:</span> <span class="token string">'‚ùå D√©connect√©'</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">SaveButton</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleSaveClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'‚úÖ Progression enregistr√©e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button disabled<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">!</span>isOnline<span class="token punctuation">}</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSaveClick<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>isOnline <span class="token operator">?</span> <span class="token string">'Enregistrer la progression'</span> <span class="token operator">:</span> <span class="token string">'Reconnexion...'</span><span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">SaveButton</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">StatusBar</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> isOnline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack></section><section class="level3"aria-labelledby="prendre-en-charge-le-rendu-c√¥t√©-serveur-adding-support-for-server-rendering"><h3 id="prendre-en-charge-le-rendu-c√¥t√©-serveur-adding-support-for-server-rendering">Prendre en charge le rendu c√¥t√© serveur {/<em>adding-support-for-server-rendering</em>/}</h3><p>Si votre appli React utilise le <a href="/reference/react-dom/server">rendu c√¥t√© serveur</a>, vos composants React seront aussi ex√©cut√©s hors d'un environnement navigateur pour g√©n√©rer le HTML initial. √áa complexifie un peu la connexion √† la source de donn√©es ext√©rieure¬†:<ul><li>Si vous vous connectez √† une API strictement navigateur, √ßa ne marchera pas car elle n'existera pas, par d√©finition, c√¥t√© serveur.<li>Si vous vous connectez √† une source de donn√©es tierce, vous aurez besoin que ses donn√©es correspondent c√¥t√© serveur et c√¥t√© client.</ul><p>Pour pouvoir r√©soudre ces probl√©matiques, passez une fonction <code>getServerSnapshot</code> comme troisi√®me argument √† <code>useSyncExternalStore</code>¬†:<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">,</span> getServerSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> isOnline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getServerSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// Toujours dire ¬´¬†En ligne¬†¬ª pour le HTML g√©n√©r√© c√¥t√© serveur</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>La fonction <code>getServerSnapshot</code> est similaire √† <code>getSnapshot</code>, mais elle n'est ex√©cut√©e que dans deux cas¬†:<ul><li>C√¥t√© serveur pour g√©n√©rer le HTML.<li>C√¥t√© client lors de <a href="/reference/react-dom/client/hydrateRoot">l'hydratation</a>, c'est-√†-dire lorsque React reprend la main sur le HTML renvoy√© par le serveur pour le rendre interactif.</ul><p>√áa vous permet de fournir une valeur initiale de l'instantan√© que vous pourrez utiliser avant que l'appli devienne interactive. Si vous n'avez pas de valeur initiale pertinente √† fournir lors du rendu c√¥t√© serveur, omettez cet argument pour <a href="/reference/react/Suspense#providing-a-fallback-for-server-errors-and-server-only-content">forcer le rendu c√¥t√© client</a>.</p><note><p>Assurez-vous que <code>getServerSnapshot</code> renvoie exactement la m√™me valeur lors du rendu client initial et lors du rendu c√¥t√© serveur. Par exemple, si <code>getServerSnapshot</code> renvoie un contenu pr√©rempli de la source de donn√©es c√¥t√© serveur, vous devez transf√©rer ce contenu au client. Une fa√ßon d'y parvenir consiste √† √©mettre une balise <code>&#x3C;script></code> pendant le rendu c√¥t√© serveur qui d√©finit une globale du genre <code>window.MY_STORE_DATA</code>, puis de lire cette globale c√¥t√© client au sein de <code>getServerSnapshot</code>. Votre source de donne√©s ext√©rieure documente probablement comment faire √ßa.</p></note></section></section><section class="level2"aria-labelledby="d√©pannage-troubleshooting"><h2 id="d√©pannage-troubleshooting">D√©pannage {/<em>troubleshooting</em>/}</h2><section class="level3"aria-labelledby="jai-une-erreur-the-result-of-getsnapshot-should-be-cached-im-getting-an-error-the-result-of-getsnapshot-should-be-cached"><h3 id="jai-une-erreur-the-result-of-getsnapshot-should-be-cached-im-getting-an-error-the-result-of-getsnapshot-should-be-cached">J'ai une erreur¬†: ‚ÄúThe result of <code>getSnapshot</code> should be cached‚Äù {/<em>im-getting-an-error-the-result-of-getsnapshot-should-be-cached</em>/}</h3><p><em>(¬´¬†Le r√©sultat de <code>getSnapshot</code> devrait √™tre mis en cache¬†¬ª, NdT.)</em><p>Cette erreur signifie que la fonction <code>getSnapshot</code> renvoie un nouvel objet √† chaque fois qu'on l'appelle¬†:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// üî¥ Ne renvoyez pas un nouvel objet √† chaque fois depuis getSnapshot</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">todos</span><span class="token operator">:</span> myStore<span class="token punctuation">.</span><span class="token property-access">todos</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>React refera le rendu du composant si la valeur renvoy√©e par <code>getSnapshot</code> diff√®re de celle du dernier appel. C'est pourquoi, si vous renvoyez √† chaque fois une nouvelle valeur, vous aboutirez √† un cycle infini de rendus et obtiendrez cette erreur.<p>Votre fonction <code>getSnapshot</code> ne devrait renvoyer un objet diff√©rent que si quelque chose a vraiment chang√©. Si votre source de donn√©es contient des donn√©es immuables, vous pouvez les renvoyer directement¬†:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ‚úÖ Vous pouvez renvoyer directement des donn√©es immuables</span>
  <span class="token keyword control-flow">return</span> myStore<span class="token punctuation">.</span><span class="token property-access">todos</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Si les donn√©es de votre source sont modifiables, votre fonction <code>getSnapshot</code> devrait en renvoyer un instantan√© immuable. √áa implique en effet qu'elle <em>doive</em> cr√©er de nouveaux objets, mais pas √† chaque appel. Elle devrait plut√¥t stocker le dernier instantan√© produit, et renvoyer ce m√™me instantan√© jusqu'√† ce que la donn√©e √† la source ait chang√©. Les d√©tails de d√©tection de ce changement varient selon la source exploit√©e.</section><section class="level3"aria-labelledby="ma-fonction-subscribe-est-appel√©e-apr√®s-chaque-rendu-my-subscribe-function-gets-called-after-every-re-render"><h3 id="ma-fonction-subscribe-est-appel√©e-apr√®s-chaque-rendu-my-subscribe-function-gets-called-after-every-re-render">Ma fonction <code>subscribe</code> est appel√©e apr√®s chaque rendu {/<em>my-subscribe-function-gets-called-after-every-re-render</em>/}</h3><p>La fonction <code>subscribe</code> est d√©finie <em>au sein</em> du composant, du coup elle diff√®re √† chaque rendu¬†:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// üö© Toujours une fonction diff√©rente, donc React se r√©abonne √† chaque rendu</span>
  <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>React se r√©abonnera √† votre source de donn√©es d√®s que vous passez une fonction <code>subscribe</code> diff√©rente d'un rendu √† l'autre. Si √ßa nuit aux performances et que vous souhaitez √©viter un r√©abonnement, sortez la fonction <code>subscribe</code> du composant¬†:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// ‚úÖ Toujours la m√™me fonction, donc React ne se r√©abonne pas</span>
<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Vous pouvez aussi enrober <code>subscribe</code> dans un appel √† <a href="/reference/react/useCallback"><code>useCallback</code></a> pour ne vous r√©abonner que lorsqu'une d√©pendance change¬†:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> userId <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ‚úÖ M√™me fonction tant que userId ne change pas</span>
  <span class="token keyword">const</span> subscribe <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>userId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>