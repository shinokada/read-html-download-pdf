<!doctype html><html lang="en"><meta charset="utf-8"><title>Authentication</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="authentication"class="level3"><h3>Authentication</h3><p>Authentication is an <strong>essential</strong> part of most applications. There are many different approaches and strategies to handle authentication. The approach taken for any project depends on its particular application requirements. This chapter presents several approaches to authentication that can be adapted to a variety of different requirements.<p><a href="https://github.com/jaredhanson/passport">Passport</a> is the most popular node.js authentication library, well-known by the community and successfully used in many production applications. It's straightforward to integrate this library with a <strong>Nest</strong> application using the <code>@nestjs/passport</code> module. At a high level, Passport executes a series of steps to:<ul><li>Authenticate a user by verifying their "credentials" (such as username/password, JSON Web Token (<a href="https://jwt.io/">JWT</a>), or identity token from an Identity Provider)<li>Manage authenticated state (by issuing a portable token, such as a JWT, or creating an <a href="https://github.com/expressjs/session">Express session</a>)<li>Attach information about the authenticated user to the <code>Request</code> object for further use in route handlers</ul><p>Passport has a rich ecosystem of <a href="http://www.passportjs.org/">strategies</a> that implement various authentication mechanisms. While simple in concept, the set of Passport strategies you can choose from is large and presents a lot of variety. Passport abstracts these varied steps into a standard pattern, and the <code>@nestjs/passport</code> module wraps and standardizes this pattern into familiar Nest constructs.<p>In this chapter, we'll implement a complete end-to-end authentication solution for a RESTful API server using these powerful and flexible modules. You can use the concepts described here to implement any Passport strategy to customize your authentication scheme. You can follow the steps in this chapter to build this complete example. You can find a repository with a completed sample app <a href="https://github.com/nestjs/nest/tree/master/sample/19-auth-jwt">here</a>.<section id="authentication-requirements"class="level4"><h4>Authentication requirements</h4><p>Let's flesh out our requirements. For this use case, clients will start by authenticating with a username and password. Once authenticated, the server will issue a JWT that can be sent as a <a href="https://tools.ietf.org/html/rfc6750">bearer token in an authorization header</a> on subsequent requests to prove authentication. We'll also create a protected route that is accessible only to requests that contain a valid JWT.<p>We'll start with the first requirement: authenticating a user. We'll then extend that by issuing a JWT. Finally, we'll create a protected route that checks for a valid JWT on the request.<p>First we need to install the required packages. Passport provides a strategy called <a href="https://github.com/jaredhanson/passport-local">passport-local</a> that implements a username/password authentication mechanism, which suits our needs for this portion of our use case.<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save @nestjs/passport passport passport-local
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev @types/passport-local</code></pre><blockquote><p>warning <strong>Notice</strong> For <strong>any</strong> Passport strategy you choose, you'll always need the <code>@nestjs/passport</code> and <code>passport</code> packages. Then, you'll need to install the strategy-specific package (e.g., <code>passport-jwt</code> or <code>passport-local</code>) that implements the particular authentication strategy you are building. In addition, you can also install the type definitions for any Passport strategy, as shown above with <code>@types/passport-local</code>, which provides assistance while writing TypeScript code.</blockquote></section><section id="implementing-passport-strategies"class="level4"><h4>Implementing Passport strategies</h4><p>We're now ready to implement the authentication feature. We'll start with an overview of the process used for <strong>any</strong> Passport strategy. It's helpful to think of Passport as a mini framework in itself. The elegance of the framework is that it abstracts the authentication process into a few basic steps that you customize based on the strategy you're implementing. It's like a framework because you configure it by supplying customization parameters (as plain JSON objects) and custom code in the form of callback functions, which Passport calls at the appropriate time. The <code>@nestjs/passport</code> module wraps this framework in a Nest style package, making it easy to integrate into a Nest application. We'll use <code>@nestjs/passport</code> below, but first let's consider how <strong>vanilla Passport</strong> works.<p>In vanilla Passport, you configure a strategy by providing two things:<ol><li>A set of options that are specific to that strategy. For example, in a JWT strategy, you might provide a secret to sign tokens.<li>A "verify callback", which is where you tell Passport how to interact with your user store (where you manage user accounts). Here, you verify whether a user exists (and/or create a new user), and whether their credentials are valid. The Passport library expects this callback to return a full user if the validation succeeds, or a null if it fails (failure is defined as either the user is not found, or, in the case of passport-local, the password does not match).</ol><p>With <code>@nestjs/passport</code>, you configure a Passport strategy by extending the <code>PassportStrategy</code> class. You pass the strategy options (item 1 above) by calling the <code>super()</code> method in your subclass, optionally passing in an options object. You provide the verify callback (item 2 above) by implementing a <code>validate()</code> method in your subclass.<p>We'll start by generating an <code>AuthModule</code> and in it, an <code>AuthService</code>:<pre class="language-bash"><code class="language-bash">$ nest g module auth
$ nest g <span class="token function">service</span> auth</code></pre><p>As we implement the <code>AuthService</code>, we'll find it useful to encapsulate user operations in a <code>UsersService</code>, so let's generate that module and service now:<pre class="language-bash"><code class="language-bash">$ nest g module <span class="token function">users</span>
$ nest g <span class="token function">service</span> <span class="token function">users</span></code></pre><p>Replace the default contents of these generated files as shown below. For our sample app, the <code>UsersService</code> simply maintains a hard-coded in-memory list of users, and a find method to retrieve one by username. In a real app, this is where you'd build your user model and persistence layer, using your library of choice (e.g., TypeORM, Sequelize, Mongoose, etc.).<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>users<span class="token operator">/</span>users<span class="token punctuation">.</span><span class="token property-access">service</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token comment">// This should be a real class/interface representing a user entity</span>
<span class="token keyword module">export</span> <span class="token keyword">type</span> <span class="token class-name"><span class="token maybe-class-name">User</span></span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersService</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">readonly</span> users <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      userId<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      username<span class="token operator">:</span> <span class="token string">'john'</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token string">'changeme'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      userId<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      username<span class="token operator">:</span> <span class="token string">'maria'</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token string">'guess'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">User</span> <span class="token operator">|</span> <span class="token keyword nil">undefined</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">users</span><span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span>user <span class="token arrow operator">=></span> user<span class="token punctuation">.</span><span class="token property-access">username</span> <span class="token operator">===</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">users</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        userId<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        username<span class="token operator">:</span> <span class="token string">'john'</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token string">'changeme'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        userId<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        username<span class="token operator">:</span> <span class="token string">'maria'</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token string">'guess'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">users</span><span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span>user <span class="token arrow operator">=></span> user<span class="token punctuation">.</span><span class="token property-access">username</span> <span class="token operator">===</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>In the <code>UsersModule</code>, the only change needed is to add the <code>UsersService</code> to the exports array of the <code>@Module</code> decorator so that it is visible outside this module (we'll soon use it in our <code>AuthService</code>).<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>users<span class="token operator">/</span>users<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Our <code>AuthService</code> has the job of retrieving a user and verifying the password. We create a <code>validateUser()</code> method for this purpose. In the code below, we use a convenient ES6 spread operator to strip the password property from the user object before returning it. We'll be calling into the <code>validateUser()</code> method from our Passport local strategy in a moment.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>auth<span class="token operator">/</span>auth<span class="token punctuation">.</span><span class="token property-access">service</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../users/users.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> usersService<span class="token operator">:</span> <span class="token maybe-class-name">UsersService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validateUser</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> pass<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>user <span class="token operator">&#x26;&#x26;</span> user<span class="token punctuation">.</span><span class="token property-access">password</span> <span class="token operator">===</span> pass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> password<span class="token punctuation">,</span> <span class="token spread operator">...</span>result <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
      <span class="token keyword control-flow">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Dependencies</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../users/users.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>usersService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span> <span class="token operator">=</span> usersService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validateUser</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> pass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>user <span class="token operator">&#x26;&#x26;</span> user<span class="token punctuation">.</span><span class="token property-access">password</span> <span class="token operator">===</span> pass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> password<span class="token punctuation">,</span> <span class="token spread operator">...</span>result <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
      <span class="token keyword control-flow">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>Warning <strong>Warning</strong> Of course in a real application, you wouldn't store a password in plain text. You'd instead use a library like <a href="https://github.com/kelektiv/node.bcrypt.js#readme">bcrypt</a>, with a salted one-way hash algorithm. With that approach, you'd only store hashed passwords, and then compare the stored password to a hashed version of the <strong>incoming</strong> password, thus never storing or exposing user passwords in plain text. To keep our sample app simple, we violate that absolute mandate and use plain text. <strong>Don't do this in your real app!</strong></blockquote><p>Now, we update our <code>AuthModule</code> to import the <code>UsersModule</code>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>auth<span class="token operator">/</span>auth<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="implementing-passport-local"class="level4"><h4>Implementing Passport local</h4><p>Now we can implement our Passport <strong>local authentication strategy</strong>. Create a file called <code>local.strategy.ts</code> in the <code>auth</code> folder, and add the following code:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>auth<span class="token operator">/</span>local<span class="token punctuation">.</span><span class="token property-access">strategy</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Strategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'passport-local'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PassportStrategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UnauthorizedException</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">LocalStrategy</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">PassportStrategy</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Strategy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> authService<span class="token operator">:</span> <span class="token maybe-class-name">AuthService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">authService</span><span class="token punctuation">.</span><span class="token method function property-access">validateUser</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">UnauthorizedException</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Strategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'passport-local'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PassportStrategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UnauthorizedException</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Dependencies</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">LocalStrategy</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">PassportStrategy</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Strategy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>authService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">authService</span> <span class="token operator">=</span> authService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">authService</span><span class="token punctuation">.</span><span class="token method function property-access">validateUser</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">UnauthorizedException</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>We've followed the recipe described earlier for all Passport strategies. In our use case with passport-local, there are no configuration options, so our constructor simply calls <code>super()</code>, without an options object.<blockquote><p>info <strong>Hint</strong> We can pass an options object in the call to <code>super()</code> to customize the behavior of the passport strategy. In this example, the passport-local strategy by default expects properties called <code>username</code> and <code>password</code> in the request body. Pass an options object to specify different property names, for example: <code>super({{ '{' }} usernameField: 'email' {{ '}' }})</code>. See the <a href="http://www.passportjs.org/docs/configure/">Passport documentation</a> for more information.</blockquote><p>We've also implemented the <code>validate()</code> method. For each strategy, Passport will call the verify function (implemented with the <code>validate()</code> method in <code>@nestjs/passport</code>) using an appropriate strategy-specific set of parameters. For the local-strategy, Passport expects a <code>validate()</code> method with the following signature: <code>validate(username: string, password:string): any</code>.<p>Most of the validation work is done in our <code>AuthService</code> (with the help of our <code>UsersService</code>), so this method is quite straightforward. The <code>validate()</code> method for <strong>any</strong> Passport strategy will follow a similar pattern, varying only in the details of how credentials are represented. If a user is found and the credentials are valid, the user is returned so Passport can complete its tasks (e.g., creating the <code>user</code> property on the <code>Request</code> object), and the request handling pipeline can continue. If it's not found, we throw an exception and let our <a href="exception-filters">exceptions layer</a> handle it.<p>Typically, the only significant difference in the <code>validate()</code> method for each strategy is <strong>how</strong> you determine if a user exists and is valid. For example, in a JWT strategy, depending on requirements, we may evaluate whether the <code>userId</code> carried in the decoded token matches a record in our user database, or matches a list of revoked tokens. Hence, this pattern of sub-classing and implementing strategy-specific validation is consistent, elegant and extensible.<p>We need to configure our <code>AuthModule</code> to use the Passport features we just defined. Update <code>auth.module.ts</code> to look like this:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>auth<span class="token operator">/</span>auth<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PassportModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LocalStrategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./local.strategy'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersModule</span><span class="token punctuation">,</span> <span class="token maybe-class-name">PassportModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">,</span> <span class="token maybe-class-name">LocalStrategy</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PassportModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LocalStrategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./local.strategy'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersModule</span><span class="token punctuation">,</span> <span class="token maybe-class-name">PassportModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">,</span> <span class="token maybe-class-name">LocalStrategy</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="built-in-passport-guards"class="level4"><h4>Built-in Passport Guards</h4><p>The <a href="guards">Guards</a> chapter describes the primary function of Guards: to determine whether a request will be handled by the route handler or not. That remains true, and we'll use that standard capability soon. However, in the context of using the <code>@nestjs/passport</code> module, we will also introduce a slight new wrinkle that may at first be confusing, so let's discuss that now. Consider that your app can exist in two states, from an authentication perspective:<ol><li>the user/client is <strong>not</strong> logged in (is not authenticated)<li>the user/client <strong>is</strong> logged in (is authenticated)</ol><p>In the first case (user is not logged in), we need to perform two distinct functions:<ul><li><p>Restrict the routes an unauthenticated user can access (i.e., deny access to restricted routes). We'll use Guards in their familiar capacity to handle this function, by placing a Guard on the protected routes. As you may anticipate, we'll be checking for the presence of a valid JWT in this Guard, so we'll work on this Guard later, once we are successfully issuing JWTs.<li><p>Initiate the <strong>authentication step</strong> itself when a previously unauthenticated user attempts to login. This is the step where we'll <strong>issue</strong> a JWT to a valid user. Thinking about this for a moment, we know we'll need to <code>POST</code> username/password credentials to initiate authentication, so we'll set up a <code>POST /auth/login</code> route to handle that. This raises the question: how exactly do we invoke the passport-local strategy in that route?</ul><p>The answer is straightforward: by using another, slightly different type of Guard. The <code>@nestjs/passport</code> module provides us with a built-in Guard that does this for us. This Guard invokes the Passport strategy and kicks off the steps described above (retrieving credentials, running the verify function, creating the <code>user</code> property, etc).<p>The second case enumerated above (logged in user) simply relies on the standard type of Guard we already discussed to enable access to protected routes for logged in users.<p><app-banner-courses-auth></app-banner-courses-auth></section><section id="login-route"class="level4"><h4>Login route</h4><p>With the strategy in place, we can now implement a bare-bones <code>/auth/login</code> route, and apply the built-in Guard to initiate the passport-local flow.<p>Open the <code>app.controller.ts</code> file and replace its contents with the following:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Controller</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UseGuards</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthGuard</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppController</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">UseGuards</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">AuthGuard</span></span><span class="token punctuation">(</span><span class="token string">'local'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">'auth/login'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Request</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> req<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Controller</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Bind</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UseGuards</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthGuard</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppController</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">UseGuards</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">AuthGuard</span></span><span class="token punctuation">(</span><span class="token string">'local'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">'auth/login'</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Request</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> req<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>With <code>@UseGuards(AuthGuard('local'))</code> we are using an <code>AuthGuard</code> that <code>@nestjs/passport</code> <strong>automatically provisioned</strong> for us when we extended the passport-local strategy. Let's break that down. Our Passport local strategy has a default name of <code>'local'</code>. We reference that name in the <code>@UseGuards()</code> decorator to associate it with code supplied by the <code>passport-local</code> package. This is used to disambiguate which strategy to invoke in case we have multiple Passport strategies in our app (each of which may provision a strategy-specific <code>AuthGuard</code>). While we only have one such strategy so far, we'll shortly add a second, so this is needed for disambiguation.<p>In order to test our route we'll have our <code>/auth/login</code> route simply return the user for now. This also lets us demonstrate another Passport feature: Passport automatically creates a <code>user</code> object, based on the value we return from the <code>validate()</code> method, and assigns it to the <code>Request</code> object as <code>req.user</code>. Later, we'll replace this with code to create and return a JWT instead.<p>Since these are API routes, we'll test them using the commonly available <a href="https://curl.haxx.se/">cURL</a> library. You can test with any of the <code>user</code> objects hard-coded in the <code>UsersService</code>.<pre class="language-bash"><code class="language-bash">$ <span class="token comment"># POST to /auth/login</span>
$ <span class="token function">curl</span> -X POST http://localhost:3000/auth/login -d <span class="token string">'{"username": "john", "password": "changeme"}'</span> -H <span class="token string">"Content-Type: application/json"</span>
$ <span class="token comment"># result -> {"userId":1,"username":"john"}</span></code></pre><p>While this works, passing the strategy name directly to the <code>AuthGuard()</code> introduces magic strings in the codebase. Instead, we recommend creating your own class, as shown below:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>auth<span class="token operator">/</span>local<span class="token operator">-</span>auth<span class="token punctuation">.</span><span class="token property-access">guard</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthGuard</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">LocalAuthGuard</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">AuthGuard</span></span><span class="token punctuation">(</span><span class="token string">'local'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Now, we can update the <code>/auth/login</code> route handler and use the <code>LocalAuthGuard</code> instead:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">UseGuards</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">LocalAuthGuard</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">'auth/login'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Request</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> req<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section id="jwt-functionality"class="level4"><h4>JWT functionality</h4><p>We're ready to move on to the JWT portion of our auth system. Let's review and refine our requirements:<ul><li>Allow users to authenticate with username/password, returning a JWT for use in subsequent calls to protected API endpoints. We're well on our way to meeting this requirement. To complete it, we'll need to write the code that issues a JWT.<li>Create API routes which are protected based on the presence of a valid JWT as a bearer token</ul><p>We'll need to install a couple more packages to support our JWT requirements:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save @nestjs/jwt passport-jwt
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev @types/passport-jwt</code></pre><p>The <code>@nestjs/jwt</code> package (see more <a href="https://github.com/nestjs/jwt">here</a>) is a utility package that helps with JWT manipulation. The <code>passport-jwt</code> package is the Passport package that implements the JWT strategy and <code>@types/passport-jwt</code> provides the TypeScript type definitions.<p>Let's take a closer look at how a <code>POST /auth/login</code> request is handled. We've decorated the route using the built-in <code>AuthGuard</code> provided by the passport-local strategy. This means that:<ol><li>The route handler <strong>will only be invoked if the user has been validated</strong><li>The <code>req</code> parameter will contain a <code>user</code> property (populated by Passport during the passport-local authentication flow)</ol><p>With this in mind, we can now finally generate a real JWT, and return it in this route. To keep our services cleanly modularized, we'll handle generating the JWT in the <code>authService</code>. Open the <code>auth.service.ts</code> file in the <code>auth</code> folder, and add the <code>login()</code> method, and import the <code>JwtService</code> as shown:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>auth<span class="token operator">/</span>auth<span class="token punctuation">.</span><span class="token property-access">service</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../users/users.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">JwtService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> usersService<span class="token operator">:</span> <span class="token maybe-class-name">UsersService</span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> jwtService<span class="token operator">:</span> <span class="token maybe-class-name">JwtService</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validateUser</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> pass<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>user <span class="token operator">&#x26;&#x26;</span> user<span class="token punctuation">.</span><span class="token property-access">password</span> <span class="token operator">===</span> pass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> password<span class="token punctuation">,</span> <span class="token spread operator">...</span>result <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
      <span class="token keyword control-flow">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span>user<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span> username<span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token property-access">username</span><span class="token punctuation">,</span> sub<span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token property-access">userId</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      access_token<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">jwtService</span><span class="token punctuation">.</span><span class="token method function property-access">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Dependencies</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../users/users.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">JwtService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">,</span> <span class="token maybe-class-name">JwtService</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>usersService<span class="token punctuation">,</span> jwtService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span> <span class="token operator">=</span> usersService<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">jwtService</span> <span class="token operator">=</span> jwtService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validateUser</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> pass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>user <span class="token operator">&#x26;&#x26;</span> user<span class="token punctuation">.</span><span class="token property-access">password</span> <span class="token operator">===</span> pass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> password<span class="token punctuation">,</span> <span class="token spread operator">...</span>result <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
      <span class="token keyword control-flow">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span> username<span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token property-access">username</span><span class="token punctuation">,</span> sub<span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token property-access">userId</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      access_token<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">jwtService</span><span class="token punctuation">.</span><span class="token method function property-access">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>We're using the <code>@nestjs/jwt</code> library, which supplies a <code>sign()</code> function to generate our JWT from a subset of the <code>user</code> object properties, which we then return as a simple object with a single <code>access_token</code> property. Note: we choose a property name of <code>sub</code> to hold our <code>userId</code> value to be consistent with JWT standards. Don't forget to inject the JwtService provider into the <code>AuthService</code>.<p>We now need to update the <code>AuthModule</code> to import the new dependencies and configure the <code>JwtModule</code>.<p>First, create <code>constants.ts</code> in the <code>auth</code> folder, and add the following code:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>auth<span class="token operator">/</span>constants<span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> jwtConstants <span class="token operator">=</span> <span class="token punctuation">{</span>
  secret<span class="token operator">:</span> <span class="token string">'secretKey'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> jwtConstants <span class="token operator">=</span> <span class="token punctuation">{</span>
  secret<span class="token operator">:</span> <span class="token string">'secretKey'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>We'll use this to share our key between the JWT signing and verifying steps.<blockquote><p>Warning <strong>Warning</strong> <strong>Do not expose this key publicly</strong>. We have done so here to make it clear what the code is doing, but in a production system <strong>you must protect this key</strong> using appropriate measures such as a secrets vault, environment variable, or configuration service.</blockquote><p>Now, open <code>auth.module.ts</code> in the <code>auth</code> folder and update it to look like this:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>auth<span class="token operator">/</span>auth<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LocalStrategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./local.strategy'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PassportModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">JwtModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> jwtConstants <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">UsersModule</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">PassportModule</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">JwtModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token operator">:</span> jwtConstants<span class="token punctuation">.</span><span class="token property-access">secret</span><span class="token punctuation">,</span>
      signOptions<span class="token operator">:</span> <span class="token punctuation">{</span> expiresIn<span class="token operator">:</span> <span class="token string">'60s'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">,</span> <span class="token maybe-class-name">LocalStrategy</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LocalStrategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./local.strategy'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PassportModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">JwtModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> jwtConstants <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">UsersModule</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">PassportModule</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">JwtModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token operator">:</span> jwtConstants<span class="token punctuation">.</span><span class="token property-access">secret</span><span class="token punctuation">,</span>
      signOptions<span class="token operator">:</span> <span class="token punctuation">{</span> expiresIn<span class="token operator">:</span> <span class="token string">'60s'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">,</span> <span class="token maybe-class-name">LocalStrategy</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>We configure the <code>JwtModule</code> using <code>register()</code>, passing in a configuration object. See <a href="https://github.com/nestjs/jwt/blob/master/README.md">here</a> for more on the Nest <code>JwtModule</code> and <a href="https://github.com/auth0/node-jsonwebtoken#usage">here</a> for more details on the available configuration options.<p>Now we can update the <code>/auth/login</code> route to return a JWT.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Controller</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UseGuards</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LocalAuthGuard</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth/local-auth.guard'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth/auth.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppController</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> authService<span class="token operator">:</span> <span class="token maybe-class-name">AuthService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">UseGuards</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">LocalAuthGuard</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">'auth/login'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Request</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">authService</span><span class="token punctuation">.</span><span class="token method function property-access">login</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Controller</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Bind</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UseGuards</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LocalAuthGuard</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth/local-auth.guard'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth/auth.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppController</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> authService<span class="token operator">:</span> <span class="token maybe-class-name">AuthService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">UseGuards</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">LocalAuthGuard</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">'auth/login'</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Request</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">authService</span><span class="token punctuation">.</span><span class="token method function property-access">login</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Let's go ahead and test our routes using cURL again. You can test with any of the <code>user</code> objects hard-coded in the <code>UsersService</code>.<pre class="language-bash"><code class="language-bash">$ <span class="token comment"># POST to /auth/login</span>
$ <span class="token function">curl</span> -X POST http://localhost:3000/auth/login -d <span class="token string">'{"username": "john", "password": "changeme"}'</span> -H <span class="token string">"Content-Type: application/json"</span>
$ <span class="token comment"># result -> {"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."}</span>
$ <span class="token comment"># Note: above JWT truncated</span></code></pre></section><section id="implementing-passport-jwt"class="level4"><h4>Implementing Passport JWT</h4><p>We can now address our final requirement: protecting endpoints by requiring a valid JWT be present on the request. Passport can help us here too. It provides the <a href="https://github.com/mikenicholson/passport-jwt">passport-jwt</a> strategy for securing RESTful endpoints with JSON Web Tokens. Start by creating a file called <code>jwt.strategy.ts</code> in the <code>auth</code> folder, and add the following code:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>auth<span class="token operator">/</span>jwt<span class="token punctuation">.</span><span class="token property-access">strategy</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ExtractJwt</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Strategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'passport-jwt'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PassportStrategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> jwtConstants <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">JwtStrategy</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">PassportStrategy</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Strategy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      jwtFromRequest<span class="token operator">:</span> <span class="token maybe-class-name">ExtractJwt</span><span class="token punctuation">.</span><span class="token method function property-access">fromAuthHeaderAsBearerToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      ignoreExpiration<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      secretOrKey<span class="token operator">:</span> jwtConstants<span class="token punctuation">.</span><span class="token property-access">secret</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span>payload<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> userId<span class="token operator">:</span> payload<span class="token punctuation">.</span><span class="token property-access">sub</span><span class="token punctuation">,</span> username<span class="token operator">:</span> payload<span class="token punctuation">.</span><span class="token property-access">username</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ExtractJwt</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Strategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'passport-jwt'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PassportStrategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> jwtConstants <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">JwtStrategy</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">PassportStrategy</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Strategy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      jwtFromRequest<span class="token operator">:</span> <span class="token maybe-class-name">ExtractJwt</span><span class="token punctuation">.</span><span class="token method function property-access">fromAuthHeaderAsBearerToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      ignoreExpiration<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      secretOrKey<span class="token operator">:</span> jwtConstants<span class="token punctuation">.</span><span class="token property-access">secret</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> userId<span class="token operator">:</span> payload<span class="token punctuation">.</span><span class="token property-access">sub</span><span class="token punctuation">,</span> username<span class="token operator">:</span> payload<span class="token punctuation">.</span><span class="token property-access">username</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>With our <code>JwtStrategy</code>, we've followed the same recipe described earlier for all Passport strategies. This strategy requires some initialization, so we do that by passing in an options object in the <code>super()</code> call. You can read more about the available options <a href="https://github.com/mikenicholson/passport-jwt#configure-strategy">here</a>. In our case, these options are:<ul><li><code>jwtFromRequest</code>: supplies the method by which the JWT will be extracted from the <code>Request</code>. We will use the standard approach of supplying a bearer token in the Authorization header of our API requests. Other options are described <a href="https://github.com/mikenicholson/passport-jwt#extracting-the-jwt-from-the-request">here</a>.<li><code>ignoreExpiration</code>: just to be explicit, we choose the default <code>false</code> setting, which delegates the responsibility of ensuring that a JWT has not expired to the Passport module. This means that if our route is supplied with an expired JWT, the request will be denied and a <code>401 Unauthorized</code> response sent. Passport conveniently handles this automatically for us.<li><code>secretOrKey</code>: we are using the expedient option of supplying a symmetric secret for signing the token. Other options, such as a PEM-encoded public key, may be more appropriate for production apps (see <a href="https://github.com/mikenicholson/passport-jwt#configure-strategy">here</a> for more information). In any case, as cautioned earlier, <strong>do not expose this secret publicly</strong>.</ul><p>The <code>validate()</code> method deserves some discussion. For the jwt-strategy, Passport first verifies the JWT's signature and decodes the JSON. It then invokes our <code>validate()</code> method passing the decoded JSON as its single parameter. Based on the way JWT signing works, <strong>we're guaranteed that we're receiving a valid token</strong> that we have previously signed and issued to a valid user.<p>As a result of all this, our response to the <code>validate()</code> callback is trivial: we simply return an object containing the <code>userId</code> and <code>username</code> properties. Recall again that Passport will build a <code>user</code> object based on the return value of our <code>validate()</code> method, and attach it as a property on the <code>Request</code> object.<p>It's also worth pointing out that this approach leaves us room ('hooks' as it were) to inject other business logic into the process. For example, we could do a database lookup in our <code>validate()</code> method to extract more information about the user, resulting in a more enriched <code>user</code> object being available in our <code>Request</code>. This is also the place we may decide to do further token validation, such as looking up the <code>userId</code> in a list of revoked tokens, enabling us to perform token revocation. The model we've implemented here in our sample code is a fast, "stateless JWT" model, where each API call is immediately authorized based on the presence of a valid JWT, and a small bit of information about the requester (its <code>userId</code> and <code>username</code>) is available in our Request pipeline.<p>Add the new <code>JwtStrategy</code> as a provider in the <code>AuthModule</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>auth<span class="token operator">/</span>auth<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LocalStrategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./local.strategy'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">JwtStrategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./jwt.strategy'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PassportModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">JwtModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> jwtConstants <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">UsersModule</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">PassportModule</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">JwtModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token operator">:</span> jwtConstants<span class="token punctuation">.</span><span class="token property-access">secret</span><span class="token punctuation">,</span>
      signOptions<span class="token operator">:</span> <span class="token punctuation">{</span> expiresIn<span class="token operator">:</span> <span class="token string">'60s'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">,</span> <span class="token maybe-class-name">LocalStrategy</span><span class="token punctuation">,</span> <span class="token maybe-class-name">JwtStrategy</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LocalStrategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./local.strategy'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">JwtStrategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./jwt.strategy'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PassportModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">JwtModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> jwtConstants <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">UsersModule</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">PassportModule</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">JwtModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token operator">:</span> jwtConstants<span class="token punctuation">.</span><span class="token property-access">secret</span><span class="token punctuation">,</span>
      signOptions<span class="token operator">:</span> <span class="token punctuation">{</span> expiresIn<span class="token operator">:</span> <span class="token string">'60s'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">,</span> <span class="token maybe-class-name">LocalStrategy</span><span class="token punctuation">,</span> <span class="token maybe-class-name">JwtStrategy</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>By importing the same secret used when we signed the JWT, we ensure that the <strong>verify</strong> phase performed by Passport, and the <strong>sign</strong> phase performed in our AuthService, use a common secret.<p>Finally, we define the <code>JwtAuthGuard</code> class which extends the built-in <code>AuthGuard</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>auth<span class="token operator">/</span>jwt<span class="token operator">-</span>auth<span class="token punctuation">.</span><span class="token property-access">guard</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthGuard</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">JwtAuthGuard</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">AuthGuard</span></span><span class="token punctuation">(</span><span class="token string">'jwt'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="implement-protected-route-and-jwt-strategy-guards"class="level4"><h4>Implement protected route and JWT strategy guards</h4><p>We can now implement our protected route and its associated Guard.<p>Open the <code>app.controller.ts</code> file and update it as shown below:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Controller</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Get</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UseGuards</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">JwtAuthGuard</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth/jwt-auth.guard'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LocalAuthGuard</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth/local-auth.guard'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth/auth.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppController</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> authService<span class="token operator">:</span> <span class="token maybe-class-name">AuthService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">UseGuards</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">LocalAuthGuard</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">'auth/login'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Request</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">authService</span><span class="token punctuation">.</span><span class="token method function property-access">login</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">UseGuards</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">JwtAuthGuard</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'profile'</span><span class="token punctuation">)</span>
  <span class="token function">getProfile</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Request</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> req<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Controller</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Dependencies</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Bind</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Get</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UseGuards</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">JwtAuthGuard</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth/jwt-auth.guard'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LocalAuthGuard</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth/local-auth.guard'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth/auth.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppController</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>authService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">authService</span> <span class="token operator">=</span> authService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">UseGuards</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">LocalAuthGuard</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">'auth/login'</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Request</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">authService</span><span class="token punctuation">.</span><span class="token method function property-access">login</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">UseGuards</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">JwtAuthGuard</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'profile'</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Request</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">getProfile</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> req<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Once again, we're applying the <code>AuthGuard</code> that the <code>@nestjs/passport</code> module has automatically provisioned for us when we configured the passport-jwt module. This Guard is referenced by its default name, <code>jwt</code>. When our <code>GET /profile</code> route is hit, the Guard will automatically invoke our passport-jwt custom configured logic, validating the JWT, and assigning the <code>user</code> property to the <code>Request</code> object.<p>Ensure the app is running, and test the routes using <code>cURL</code>.<pre class="language-bash"><code class="language-bash">$ <span class="token comment"># GET /profile</span>
$ <span class="token function">curl</span> http://localhost:3000/profile
$ <span class="token comment"># result -> {"statusCode":401,"message":"Unauthorized"}</span>

$ <span class="token comment"># POST /auth/login</span>
$ <span class="token function">curl</span> -X POST http://localhost:3000/auth/login -d <span class="token string">'{"username": "john", "password": "changeme"}'</span> -H <span class="token string">"Content-Type: application/json"</span>
$ <span class="token comment"># result -> {"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm... }</span>

$ <span class="token comment"># GET /profile using access_token returned from previous step as bearer code</span>
$ <span class="token function">curl</span> http://localhost:3000/profile -H <span class="token string">"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm..."</span>
$ <span class="token comment"># result -> {"userId":1,"username":"john"}</span></code></pre><p>Note that in the <code>AuthModule</code>, we configured the JWT to have an expiration of <code>60 seconds</code>. This is probably too short an expiration, and dealing with the details of token expiration and refresh is beyond the scope of this article. However, we chose that to demonstrate an important quality of JWTs and the passport-jwt strategy. If you wait 60 seconds after authenticating before attempting a <code>GET /profile</code> request, you'll receive a <code>401 Unauthorized</code> response. This is because Passport automatically checks the JWT for its expiration time, saving you the trouble of doing so in your application.<p>We've now completed our JWT authentication implementation. JavaScript clients (such as Angular/React/Vue), and other JavaScript apps, can now authenticate and communicate securely with our API Server.</section><section id="example"class="level4"><h4>Example</h4><p>You can find a complete version of the code in this chapter <a href="https://github.com/nestjs/nest/tree/master/sample/19-auth-jwt">here</a>.</section><section id="extending-guards"class="level4"><h4>Extending guards</h4><p>In most cases, using a provided <code>AuthGuard</code> class is sufficient. However, there might be use-cases when you would like to simply extend the default error handling or authentication logic. For this, you can extend the built-in class and override methods within a sub-class.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">ExecutionContext</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">UnauthorizedException</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthGuard</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">JwtAuthGuard</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">AuthGuard</span></span><span class="token punctuation">(</span><span class="token string">'jwt'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">canActivate</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token maybe-class-name">ExecutionContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Add your custom authentication logic here</span>
    <span class="token comment">// for example, call super.logIn(request) to establish a session.</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">canActivate</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleRequest</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> user<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// You can throw an exception based on either "info" or "err" arguments</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>err <span class="token operator">||</span> <span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">throw</span> err <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">UnauthorizedException</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>In addition to extending the default error handling and authentication logic, we can allow authentication to go through a chain of strategies. The first strategy to succeed, redirect, or error will halt the chain. Authentication failures will proceed through each strategy in series, ultimately failing if all strategies fail.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">JwtAuthGuard</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">AuthGuard</span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'strategy_jwt_1'</span><span class="token punctuation">,</span> <span class="token string">'strategy_jwt_2'</span><span class="token punctuation">,</span> <span class="token string">'...'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token spread operator">...</span> <span class="token punctuation">}</span></code></pre></section><section id="enable-authentication-globally"class="level4"><h4>Enable authentication globally</h4><p>If the vast majority of your endpoints should be protected by default, you can register the authentication guard as a <a href="/guards#binding-guards">global guard</a> and instead of using <code>@UseGuards()</code> decorator on top of each controller, you could simply flag which routes should be public.<p>First, register the <code>JwtAuthGuard</code> as a global guard using the following construction (in any module):<pre class="language-typescript"><code class="language-typescript">providers<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token constant">APP_GUARD</span><span class="token punctuation">,</span>
    useClass<span class="token operator">:</span> <span class="token maybe-class-name">JwtAuthGuard</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span></code></pre><p>With this in place, Nest will automatically bind <code>JwtAuthGuard</code> to all endpoints.<p>Now we must provide a mechanism for declaring routes as public. For this, we can create a custom decorator using the <code>SetMetadata</code> decorator factory function.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SetMetadata</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token constant">IS_PUBLIC_KEY</span> <span class="token operator">=</span> <span class="token string">'isPublic'</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function"><span class="token maybe-class-name">Public</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function"><span class="token maybe-class-name">SetMetadata</span></span><span class="token punctuation">(</span><span class="token constant">IS_PUBLIC_KEY</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>In the file above, we exported two constants. One being our metadata key named <code>IS_PUBLIC_KEY</code>, and the other being our new decorator itself that were going to call <code>Public</code> (you can alternatively name it <code>SkipAuth</code> or <code>AllowAnon</code>, whatever fits your project).<p>Now that we have a custom <code>@Public()</code> decorator, we can use it to decorate any method, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Public</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Lastly, we need the <code>JwtAuthGuard</code> to return <code>true</code> when the <code>"isPublic"</code> metadata is found. For this, we'll use the <code>Reflector</code> class (read more <a href="/guards#putting-it-all-together">here</a>).<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">JwtAuthGuard</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">AuthGuard</span></span><span class="token punctuation">(</span><span class="token string">'jwt'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> reflector<span class="token operator">:</span> <span class="token maybe-class-name">Reflector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">canActivate</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token maybe-class-name">ExecutionContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isPublic <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reflector</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">getAllAndOverride</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token builtin">boolean</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token constant">IS_PUBLIC_KEY</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      context<span class="token punctuation">.</span><span class="token method function property-access">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      context<span class="token punctuation">.</span><span class="token method function property-access">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>isPublic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">canActivate</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="request-scoped-strategies"class="level4"><h4>Request-scoped strategies</h4><p>The passport API is based on registering strategies to the global instance of the library. Therefore strategies are not designed to have request-dependent options or to be dynamically instantiated per request (read more about the <a href="/fundamentals/injection-scopes">request-scoped</a> providers). When you configure your strategy to be request-scoped, Nest will never instantiate it since it's not tied to any specific route. There is no physical way to determine which "request-scoped" strategies should be executed per request.<p>However, there are ways to dynamically resolve request-scoped providers within the strategy. For this, we leverage the <a href="/fundamentals/module-ref">module reference</a> feature.<p>First, open the <code>local.strategy.ts</code> file and inject the <code>ModuleRef</code> in the normal way:<pre class="language-typescript"><code class="language-typescript"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> moduleRef<span class="token operator">:</span> <span class="token maybe-class-name">ModuleRef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    passReqToCallback<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>ModuleRef</code> class is imported from the <code>@nestjs/core</code> package.</blockquote><p>Be sure to set the <code>passReqToCallback</code> configuration property to <code>true</code>, as shown above.<p>In the next step, the request instance will be used to obtain the current context identifier, instead of generating a new one (read more about request context <a href="/fundamentals/module-ref#getting-current-sub-tree">here</a>).<p>Now, inside the <code>validate()</code> method of the <code>LocalStrategy</code> class, use the <code>getByRequest()</code> method of the <code>ContextIdFactory</code> class to create a context id based on the request object, and pass this to the <code>resolve()</code> call:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span>
  request<span class="token operator">:</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span>
  username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> contextId <span class="token operator">=</span> <span class="token maybe-class-name">ContextIdFactory</span><span class="token punctuation">.</span><span class="token method function property-access">getByRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// "AuthService" is a request-scoped provider</span>
  <span class="token keyword">const</span> authService <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">moduleRef</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">,</span> contextId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token spread operator">...</span>
<span class="token punctuation">}</span></code></pre><p>In the example above, the <code>resolve()</code> method will asynchronously return the request-scoped instance of the <code>AuthService</code> provider (we assumed that <code>AuthService</code> is marked as a request-scoped provider).</section><section id="customize-passport"class="level4"><h4>Customize Passport</h4><p>Any standard Passport customization options can be passed the same way, using the <code>register()</code> method. The available options depend on the strategy being implemented. For example:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">PassportModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span> session<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>You can also pass strategies an options object in their constructors to configure them. For the local strategy you can pass e.g.:<pre class="language-typescript"><code class="language-typescript"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> authService<span class="token operator">:</span> <span class="token maybe-class-name">AuthService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    usernameField<span class="token operator">:</span> <span class="token string">'email'</span><span class="token punctuation">,</span>
    passwordField<span class="token operator">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Take a look at the official <a href="http://www.passportjs.org/docs/oauth/">Passport Website</a> for property names.</section><section id="named-strategies"class="level4"><h4>Named strategies</h4><p>When implementing a strategy, you can provide a name for it by passing a second argument to the <code>PassportStrategy</code> function. If you don't do this, each strategy will have a default name (e.g., 'jwt' for jwt-strategy):<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">JwtStrategy</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">PassportStrategy</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Strategy</span><span class="token punctuation">,</span> <span class="token string">'myjwt'</span><span class="token punctuation">)</span></code></pre><p>Then, you refer to this via a decorator like <code>@UseGuards(AuthGuard('myjwt'))</code>.</section><section id="graphql"class="level4"><h4>GraphQL</h4><p>In order to use an AuthGuard with <a href="https://docs.nestjs.com/graphql/quick-start">GraphQL</a>, extend the built-in AuthGuard class and override the getRequest() method.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">GqlAuthGuard</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">AuthGuard</span></span><span class="token punctuation">(</span><span class="token string">'jwt'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">getRequest</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token maybe-class-name">ExecutionContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token maybe-class-name">GqlExecutionContext</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> ctx<span class="token punctuation">.</span><span class="token method function property-access">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">req</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>To get the current authenticated user in your graphql resolver, you can define a <code>@CurrentUser()</code> decorator:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createParamDecorator<span class="token punctuation">,</span> <span class="token maybe-class-name">ExecutionContext</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">GqlExecutionContext</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token maybe-class-name">CurrentUser</span> <span class="token operator">=</span> <span class="token function">createParamDecorator</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> context<span class="token operator">:</span> <span class="token maybe-class-name">ExecutionContext</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token maybe-class-name">GqlExecutionContext</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> ctx<span class="token punctuation">.</span><span class="token method function property-access">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">req</span><span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>To use above decorator in your resolver, be sure to include it as a parameter of your query or mutation:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span>returns <span class="token arrow operator">=></span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">UseGuards</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">GqlAuthGuard</span><span class="token punctuation">)</span>
<span class="token function">whoAmI</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">CurrentUser</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token operator">:</span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span><span class="token punctuation">.</span><span class="token method function property-access">findById</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>