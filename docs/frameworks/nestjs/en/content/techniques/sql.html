<!doctype html><html lang="en"><meta charset="utf-8"><title>Database</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="database"class="level3"><h3>Database</h3><p>Nest is database agnostic, allowing you to easily integrate with any SQL or NoSQL database. You have a number of options available to you, depending on your preferences. At the most general level, connecting Nest to a database is simply a matter of loading an appropriate Node.js driver for the database, just as you would with <a href="https://expressjs.com/en/guide/database-integration.html">Express</a> or Fastify.<p>You can also directly use any general purpose Node.js database integration <strong>library</strong> or ORM, such as <a href="https://mikro-orm.io/">MikroORM</a> also check the <a href="/recipes/mikroorm">recipe here</a>, <a href="https://sequelize.org/">Sequelize</a> (navigate to the <a href="/techniques/database#sequelize-integration">Sequelize integration</a> section), <a href="https://knexjs.org/">Knex.js</a> (<a href="https://dev.to/nestjs/build-a-nestjs-module-for-knex-js-or-other-resource-based-libraries-in-5-minutes-12an">tutorial</a>), <a href="https://github.com/typeorm/typeorm">TypeORM</a>, and <a href="https://www.github.com/prisma/prisma">Prisma</a> (<a href="/recipes/prisma">recipe</a>) , to operate at a higher level of abstraction.<p>For convenience, Nest provides tight integration with TypeORM and Sequelize out-of-the-box with the <code>@nestjs/typeorm</code> and <code>@nestjs/sequelize</code> packages respectively, which we'll cover in the current chapter, and Mongoose with <code>@nestjs/mongoose</code>, which is covered in <a href="/techniques/mongodb">this chapter</a>. These integrations provide additional NestJS-specific features, such as model/repository injection, testability, and asynchronous configuration to make accessing your chosen database even easier.</section><section id="typeorm-integration"class="level3"><h3>TypeORM Integration</h3><p>For integrating with SQL and NoSQL databases, Nest provides the <code>@nestjs/typeorm</code> package. Nest uses <a href="https://github.com/typeorm/typeorm">TypeORM</a> because it's the most mature Object Relational Mapper (ORM) available for TypeScript. Since it's written in TypeScript, it integrates well with the Nest framework.<p>To begin using it, we first install the required dependencies. In this chapter, we'll demonstrate using the popular <a href="https://www.mysql.com/">MySQL</a> Relational DBMS, but TypeORM provides support for many relational databases, such as PostgreSQL, Oracle, Microsoft SQL Server, SQLite, and even NoSQL databases like MongoDB. The procedure we walk through in this chapter will be the same for any database supported by TypeORM. You'll simply need to install the associated client API libraries for your selected database.<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save @nestjs/typeorm typeorm mysql2</code></pre><p>Once the installation process is complete, we can import the <code>TypeOrmModule</code> into the root <code>AppModule</code>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">TypeOrmModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
      host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
      port<span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
      username<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
      database<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
      entities<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      synchronize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><blockquote><p>warning <strong>Warning</strong> Setting <code>synchronize: true</code> shouldn't be used in production - otherwise you can lose production data.</blockquote><p>The <code>forRoot()</code> method supports all the configuration properties exposed by the <code>DataSource</code> constructor from the <a href="https://typeorm.io/data-source-options#common-data-source-options">TypeORM</a> package. In addition, there are several extra configuration properties described below.<table><tr><td><code>retryAttempts</code><td>Number of attempts to connect to the database (default: <code>10</code>)<tr><td><code>retryDelay</code><td>Delay between connection retry attempts (ms) (default: <code>3000</code>)<tr><td><code>autoLoadEntities</code><td>If <code>true</code>, entities will be loaded automatically (default: <code>false</code>)</table><blockquote><p>info <strong>Hint</strong> Learn more about the data source options <a href="https://typeorm.io/data-source-options">here</a>.</blockquote><p>Once this is done, the TypeORM <code>DataSource</code> and <code>EntityManager</code> objects will be available to inject across the entire project (without needing to import any modules), for example:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">DataSource</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UsersModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> dataSource<span class="token operator">:</span> <span class="token maybe-class-name">DataSource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">DataSource</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">DataSource</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UsersModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">dataSource</span> <span class="token operator">=</span> dataSource<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><section id="repository-pattern"class="level4"><h4>Repository pattern</h4><p><a href="https://github.com/typeorm/typeorm">TypeORM</a> supports the <strong>repository design pattern</strong>, so each entity has its own repository. These repositories can be obtained from the database data source.<p>To continue the example, we need at least one entity. Let's define the <code>User</code> entity.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token property-access">entity</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Entity</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Column</span><span class="token punctuation">,</span> <span class="token maybe-class-name">PrimaryGeneratedColumn</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">User</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  firstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  lastName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword module">default</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  isActive<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> Learn more about entitiesÂ in the <a href="https://typeorm.io/#/entities">TypeORM documentation</a>.</blockquote><p>The <code>User</code> entity file sits in the <code>users</code> directory. This directory contains all files related to the <code>UsersModule</code>. You can decide where to keep your model files, however, we recommend creating them near their <strong>domain</strong>, in the corresponding module directory.<p>To begin using the <code>User</code> entity, we need to let TypeORM know about it by inserting it into the <code>entities</code> array in the module <code>forRoot()</code> method options (unless you use a static glob path):<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">TypeOrmModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users/user.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
      host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
      port<span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
      username<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
      database<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
      entities<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">User</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      synchronize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Next, let's look at the <code>UsersModule</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">TypeOrmModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token maybe-class-name">User</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>This module uses the <code>forFeature()</code> method to define which repositories are registered in the current scope. With that in place, we can inject the <code>UsersRepository</code> into the <code>UsersService</code> using the <code>@InjectRepository()</code> decorator:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token property-access">service</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">InjectRepository</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Repository</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectRepository</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">User</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> usersRepository<span class="token operator">:</span> <span class="token maybe-class-name">Repository</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">User</span><span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">User</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersRepository</span><span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">User</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersRepository</span><span class="token punctuation">.</span><span class="token method function property-access">findOneBy</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersRepository</span><span class="token punctuation">.</span><span class="token method function property-access">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Dependencies</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getRepositoryToken <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token function">getRepositoryToken</span><span class="token punctuation">(</span><span class="token maybe-class-name">User</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>usersRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersRepository</span> <span class="token operator">=</span> usersRepository<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersRepository</span><span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersRepository</span><span class="token punctuation">.</span><span class="token method function property-access">findOneBy</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersRepository</span><span class="token punctuation">.</span><span class="token method function property-access">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>warning <strong>Notice</strong> Don't forget to import the <code>UsersModule</code> into the root <code>AppModule</code>.</blockquote><p>If you want to use the repository outside of the module which imports <code>TypeOrmModule.forFeature</code>, you'll need to re-export the providers generated by it. You can do this by exporting the whole module, like this:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">TypeOrmModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token maybe-class-name">User</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Now if we import <code>UsersModule</code> in <code>UserHttpModule</code>, we can use <code>@InjectRepository(User)</code> in the providers of the latter module.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>users<span class="token operator">-</span>http<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.controller'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersController</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UserHttpModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="relations"class="level4"><h4>Relations</h4><p>Relations are associations established between two or more tables. Relations are based on common fields from each table, often involving primary and foreign keys.<p>There are three types of relations:<table><tr><td><code>One-to-one</code><td>Every row in the primary table has one and only one associated row in the foreign table. Use the <code>@OneToOne()</code> decorator to define this type of relation.<tr><td><code>One-to-many / Many-to-one</code><td>Every row in the primary table has one or more related rows in the foreign table. Use the <code>@OneToMany()</code> and <code>@ManyToOne()</code> decorators to define this type of relation.<tr><td><code>Many-to-many</code><td>Every row in the primary table has many related rows in the foreign table, and every record in the foreign table has many related rows in the primary table. Use the <code>@ManyToMany()</code> decorator to define this type of relation.</table><p>To define relations in entities, use the corresponding <strong>decorators</strong>. For example, to define that each <code>User</code> can have multiple photos, use the <code>@OneToMany()</code> decorator.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token property-access">entity</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Entity</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Column</span><span class="token punctuation">,</span> <span class="token maybe-class-name">PrimaryGeneratedColumn</span><span class="token punctuation">,</span> <span class="token maybe-class-name">OneToMany</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Photo</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../photos/photo.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">User</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  firstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  lastName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword module">default</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  isActive<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">OneToMany</span></span><span class="token punctuation">(</span>type <span class="token arrow operator">=></span> <span class="token maybe-class-name">Photo</span><span class="token punctuation">,</span> photo <span class="token arrow operator">=></span> photo<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">)</span>
  photos<span class="token operator">:</span> <span class="token maybe-class-name">Photo</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> To learn more about relations in TypeORM, visit the <a href="https://typeorm.io/#/relations">TypeORM documentation</a>.</blockquote></section><section id="auto-load-entities"class="level4"><h4>Auto-load entities</h4><p>Manually adding entities to the <code>entities</code> array of the data source options can be tedious. In addition, referencing entities from the root module breaks application domain boundaries and causes leaking implementation details to other parts of the application. To address this issue, an alternative solution is provided. To automatically load entities, set the <code>autoLoadEntities</code> property of the configuration object (passed into the <code>forRoot()</code> method) to <code>true</code>, as shown below:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">TypeOrmModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>
      autoLoadEntities<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>With that option specified, every entity registered through the <code>forFeature()</code> method will be automatically added to the <code>entities</code> array of the configuration object.<blockquote><p>warning <strong>Warning</strong> Note that entities that aren't registered through the <code>forFeature()</code> method, but are only referenced from the entity (via a relationship), won't be included by way of the <code>autoLoadEntities</code> setting.</blockquote></section><section id="separating-entity-definition"class="level4"><h4>Separating entity definition</h4><p>You can define an entity and its columns right in the model, using decorators. But some people prefer to define entities and their columns inside separate files using the <a href="https://typeorm.io/#/separating-entity-definition">"entity schemas"</a>.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">EntitySchema</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token maybe-class-name">UserSchema</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">EntitySchema</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">User</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'User'</span><span class="token punctuation">,</span>
  target<span class="token operator">:</span> <span class="token maybe-class-name">User</span><span class="token punctuation">,</span>
  columns<span class="token operator">:</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token known-class-name class-name">Number</span><span class="token punctuation">,</span>
      primary<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      generated<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    firstName<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token known-class-name class-name">String</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    lastName<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token known-class-name class-name">String</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    isActive<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token known-class-name class-name">Boolean</span><span class="token punctuation">,</span>
      <span class="token keyword module">default</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  relations<span class="token operator">:</span> <span class="token punctuation">{</span>
    photos<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'one-to-many'</span><span class="token punctuation">,</span>
      target<span class="token operator">:</span> <span class="token string">'Photo'</span><span class="token punctuation">,</span> <span class="token comment">// the name of the PhotoSchema</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>warning error <strong>Warning</strong> If you provide the <code>target</code> option, the <code>name</code> option value has to be the same as the name of the target class. If you do not provide the <code>target</code> you can use any name.</blockquote><p>Nest allows you to use an <code>EntitySchema</code> instance wherever an <code>Entity</code> is expected, for example:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">TypeOrmModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UserSchema</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.schema'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token maybe-class-name">UserSchema</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="typeorm-transactions"class="level4"><h4>TypeORM Transactions</h4><p>A database transaction symbolizes a unit of work performed within a database management system against a database, and treated in a coherent and reliable way independent of other transactions. A transaction generally represents any change in a database (<a href="https://en.wikipedia.org/wiki/Database_transaction">learn more</a>).<p>There are many different strategies to handle <a href="https://typeorm.io/#/transactions">TypeORM transactions</a>. We recommend using the <code>QueryRunner</code> class because it gives full control over the transaction.<p>First, we need to inject the <code>DataSource</code> object into a class in the normal way:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> dataSource<span class="token operator">:</span> <span class="token maybe-class-name">DataSource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>DataSource</code> class is imported from the <code>typeorm</code> package.</blockquote><p>Now, we can use this object to create a transaction.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">async</span> <span class="token function">createMany</span><span class="token punctuation">(</span>users<span class="token operator">:</span> <span class="token maybe-class-name">User</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> queryRunner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">dataSource</span><span class="token punctuation">.</span><span class="token method function property-access">createQueryRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">await</span> queryRunner<span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> queryRunner<span class="token punctuation">.</span><span class="token method function property-access">startTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">await</span> queryRunner<span class="token punctuation">.</span><span class="token property-access">manager</span><span class="token punctuation">.</span><span class="token method function property-access">save</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> queryRunner<span class="token punctuation">.</span><span class="token property-access">manager</span><span class="token punctuation">.</span><span class="token method function property-access">save</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">await</span> queryRunner<span class="token punctuation">.</span><span class="token method function property-access">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// since we have errors lets rollback the changes we made</span>
    <span class="token keyword control-flow">await</span> queryRunner<span class="token punctuation">.</span><span class="token method function property-access">rollbackTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// you need to release a queryRunner which was manually instantiated</span>
    <span class="token keyword control-flow">await</span> queryRunner<span class="token punctuation">.</span><span class="token method function property-access">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> Note that the <code>dataSource</code> is used only to create the <code>QueryRunner</code>. However, to test this class would require mocking the entire <code>DataSource</code> object (which exposes several methods). Thus, we recommend using a helper factory class (e.g., <code>QueryRunnerFactory</code>) and defining an interface with a limited set of methods required to maintain transactions. This technique makes mocking these methods pretty straightforward.</blockquote><p>Alternatively, you can use the callback-style approach with the <code>transaction</code> method of the <code>DataSource</code> object (<a href="https://typeorm.io/#/transactions/creating-and-using-transactions">read more</a>).<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">async</span> <span class="token function">createMany</span><span class="token punctuation">(</span>users<span class="token operator">:</span> <span class="token maybe-class-name">User</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">dataSource</span><span class="token punctuation">.</span><span class="token method function property-access">transaction</span><span class="token punctuation">(</span><span class="token keyword">async</span> manager <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">await</span> manager<span class="token punctuation">.</span><span class="token method function property-access">save</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> manager<span class="token punctuation">.</span><span class="token method function property-access">save</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><app-banner-shop></app-banner-shop></section><section id="subscribers"class="level4"><h4>Subscribers</h4><p>With TypeORM <a href="https://typeorm.io/#/listeners-and-subscribers/what-is-a-subscriber">subscribers</a>, you can listen to specific entity events.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">DataSource</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">EntitySubscriberInterface</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">EventSubscriber</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">InsertEvent</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">EventSubscriber</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UserSubscriber</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">EntitySubscriberInterface</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">User</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>dataSource<span class="token operator">:</span> <span class="token maybe-class-name">DataSource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dataSource<span class="token punctuation">.</span><span class="token property-access">subscribers</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">listenTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token maybe-class-name">User</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">beforeInsert</span><span class="token punctuation">(</span>event<span class="token operator">:</span> <span class="token maybe-class-name">InsertEvent</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">User</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">BEFORE USER INSERTED: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token property-access">entity</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>error <strong>Warning</strong> Event subscribers can not be <a href="/fundamentals/injection-scopes">request-scoped</a>.</blockquote><p>Now, add the <code>UserSubscriber</code> class to the <code>providers</code> array:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">TypeOrmModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UserSubscriber</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.subscriber'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token maybe-class-name">User</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UserSubscriber</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> Learn more about entity subscribers <a href="https://typeorm.io/#/listeners-and-subscribers/what-is-a-subscriber">here</a>.</blockquote></section><section id="migrations"class="level4"><h4>Migrations</h4><p><a href="https://typeorm.io/#/migrations">Migrations</a> provide a way to incrementally update the database schema to keep it in sync with the application's data model while preserving existing data in the database. To generate, run, and revert migrations, TypeORM provides a dedicated <a href="https://typeorm.io/#/migrations/creating-a-new-migration">CLI</a>.<p>Migration classes are separate from the Nest application source code. Their lifecycle is maintained by the TypeORM CLI. Therefore, you are not able to leverage dependency injection and other Nest specific features with migrations. To learn more about migrations, follow the guide in the <a href="https://typeorm.io/#/migrations/creating-a-new-migration">TypeORM documentation</a>.</section><section id="multiple-databases"class="level4"><h4>Multiple databases</h4><p>Some projects require multiple database connections. This can also be achieved with this module. To work with multiple connections, first create the connections. In this case, data source naming becomes <strong>mandatory</strong>.<p>Suppose you have an <code>Album</code> entity stored in its own database.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> defaultOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'postgres'</span><span class="token punctuation">,</span>
  port<span class="token operator">:</span> <span class="token number">5432</span><span class="token punctuation">,</span>
  username<span class="token operator">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span>
  database<span class="token operator">:</span> <span class="token string">'db'</span><span class="token punctuation">,</span>
  synchronize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>defaultOptions<span class="token punctuation">,</span>
      host<span class="token operator">:</span> <span class="token string">'user_db_host'</span><span class="token punctuation">,</span>
      entities<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">User</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>defaultOptions<span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">'albumsConnection'</span><span class="token punctuation">,</span>
      host<span class="token operator">:</span> <span class="token string">'album_db_host'</span><span class="token punctuation">,</span>
      entities<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">Album</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><blockquote><p>warning <strong>Notice</strong> If you don't set the <code>name</code> for a data source, its name is set to <code>default</code>. Please note that you shouldn't have multiple connections without a name, or with the same name, otherwise they will get overridden.</blockquote><blockquote><p>warning <strong>Notice</strong> If you are using <code>TypeOrmModule.forRootAsync</code>, you have to <strong>also</strong> set the data source name outside <code>useFactory</code>. For example:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'albumsConnection'</span><span class="token punctuation">,</span>
  useFactory<span class="token operator">:</span> <span class="token spread operator">...</span><span class="token punctuation">,</span>
  inject<span class="token operator">:</span> <span class="token spread operator">...</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code></pre><p>See <a href="https://github.com/nestjs/typeorm/issues/86">this issue</a> for more details.</blockquote><p>At this point, you have <code>User</code> and <code>Album</code> entities registered with their own data source. With this setup, you have to tell the <code>TypeOrmModule.forFeature()</code> method and the <code>@InjectRepository()</code> decorator which data source should be used. If you do not pass any data source name, the <code>default</code> data source is used.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token maybe-class-name">User</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token maybe-class-name">Album</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'albumsConnection'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>You can also inject the <code>DataSource</code> or <code>EntityManager</code> for a given data source:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AlbumsService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectDataSource</span></span><span class="token punctuation">(</span><span class="token string">'albumsConnection'</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> dataSource<span class="token operator">:</span> <span class="token maybe-class-name">DataSource</span><span class="token punctuation">,</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectEntityManager</span></span><span class="token punctuation">(</span><span class="token string">'albumsConnection'</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> entityManager<span class="token operator">:</span> <span class="token maybe-class-name">EntityManager</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>It's also possible to inject any <code>DataSource</code> to the providers:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      provide<span class="token operator">:</span> <span class="token maybe-class-name">AlbumsService</span><span class="token punctuation">,</span>
      <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>albumsConnection<span class="token operator">:</span> <span class="token maybe-class-name">DataSource</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">AlbumsService</span></span><span class="token punctuation">(</span>albumsConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">getDataSourceToken</span><span class="token punctuation">(</span><span class="token string">'albumsConnection'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AlbumsModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="testing"class="level4"><h4>Testing</h4><p>When it comes to unit testing an application, we usually want to avoid making a database connection, keeping our test suites independent and their execution process as fast as possible. But our classes might depend on repositories that are pulled from the data source (connection) instance. How do we handle that? The solution is to create mock repositories. In order to achieve that, we set up <a href="/fundamentals/custom-providers">custom providers</a>. Each registered repository is automatically represented by an <code>&#x3C;EntityName>Repository</code> token, where <code>EntityName</code> is the name of your entity class.<p>The <code>@nestjs/typeorm</code> package exposes the <code>getRepositoryToken()</code> function which returns a prepared token based on a given entity.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">UsersService</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      provide<span class="token operator">:</span> <span class="token function">getRepositoryToken</span><span class="token punctuation">(</span><span class="token maybe-class-name">User</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      useValue<span class="token operator">:</span> mockRepository<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Now a substitute <code>mockRepository</code> will be used as the <code>UsersRepository</code>. Whenever any class asks for <code>UsersRepository</code> using an <code>@InjectRepository()</code> decorator, Nest will use the registered <code>mockRepository</code> object.</section><section id="async-configuration"class="level4"><h4>Async configuration</h4><p>You may want to pass your repository module options asynchronously instead of statically. In this case, use the <code>forRootAsync()</code> method, which provides several ways to deal with async configuration.<p>One approach is to use a factory function:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
    username<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    password<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    database<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
    entities<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    synchronize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Our factory behaves like any other <a href="https://docs.nestjs.com/fundamentals/async-providers">asynchronous provider</a> (e.g., it can be <code>async</code> and it's able to inject dependencies through <code>inject</code>).<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>configService<span class="token operator">:</span> <span class="token maybe-class-name">ConfigService</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    host<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'HOST'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token operator">+</span>configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'PORT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    username<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'USERNAME'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    password<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'PASSWORD'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    database<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'DATABASE'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    entities<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    synchronize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Alternatively, you can use the <code>useClass</code> syntax:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  useClass<span class="token operator">:</span> <span class="token maybe-class-name">TypeOrmConfigService</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The construction above will instantiate <code>TypeOrmConfigService</code> inside <code>TypeOrmModule</code> and use it to provide an options object by calling <code>createTypeOrmOptions()</code>. Note that this means that the <code>TypeOrmConfigService</code> has to implement the <code>TypeOrmOptionsFactory</code> interface, as shown below:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">TypeOrmConfigService</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">TypeOrmOptionsFactory</span></span> <span class="token punctuation">{</span>
  <span class="token function">createTypeOrmOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">TypeOrmModuleOptions</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
      host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
      port<span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
      username<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
      database<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
      entities<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      synchronize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>In order to prevent the creation of <code>TypeOrmConfigService</code> inside <code>TypeOrmModule</code> and use a provider imported from a different module, you can use the <code>useExisting</code> syntax.<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  useExisting<span class="token operator">:</span> <span class="token maybe-class-name">ConfigService</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This construction works the same as <code>useClass</code> with one critical difference - <code>TypeOrmModule</code> will lookup imported modules to reuse an existing <code>ConfigService</code> instead of instantiating a new one.<blockquote><p>info <strong>Hint</strong> Make sure that the <code>name</code> property is defined at the same level as the <code>useFactory</code>, <code>useClass</code>, or <code>useValue</code> property. This will allow Nest to properly register the data source under the appropriate injection token.</blockquote></section><section id="custom-datasource-factory"class="level4"><h4>Custom DataSource Factory</h4><p>In conjunction with async configuration using <code>useFactory</code>, <code>useClass</code>, or <code>useExisting</code>, you can optionally specify a <code>dataSourceFactory</code> function which will allow you to provide your own TypeORM data source rather than allowing <code>TypeOrmModule</code> to create the data source.<p><code>dataSourceFactory</code> receives the TypeORM <code>DataSourceOptions</code> configured during async configuration using <code>useFactory</code>, <code>useClass</code>, or <code>useExisting</code> and returns a <code>Promise</code> that resolves a TypeORM <code>DataSource</code>.<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">TypeOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// Use useFactory, useClass, or useExisting</span>
  <span class="token comment">// to configure the DataSourceOptions.</span>
  <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>configService<span class="token operator">:</span> <span class="token maybe-class-name">ConfigService</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    host<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'HOST'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token operator">+</span>configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'PORT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    username<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'USERNAME'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    password<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'PASSWORD'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    database<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'DATABASE'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    entities<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    synchronize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// dataSource receives the configured DataSourceOptions</span>
  <span class="token comment">// and returns a Promise&#x3C;DataSource>.</span>
  <span class="token function-variable function">dataSourceFactory</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dataSource <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">DataSource</span></span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> dataSource<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>DataSource</code> class is imported from the <code>typeorm</code> package.</blockquote></section><section id="example"class="level4"><h4>Example</h4><p>A working example is available <a href="https://github.com/nestjs/nest/tree/master/sample/05-sql-typeorm">here</a>.<p><app-banner-enterprise></app-banner-enterprise></section></section><section id="sequelize-integration"class="level3"><h3>Sequelize Integration</h3><p>An alternative to using TypeORM is to use the <a href="https://sequelize.org/">Sequelize</a> ORM with the <code>@nestjs/sequelize</code> package. In addition, we leverage the <a href="https://github.com/RobinBuschmann/sequelize-typescript">sequelize-typescript</a> package which provides a set of additional decorators to declaratively define entities.<p>To begin using it, we first install the required dependencies. In this chapter, we'll demonstrate using the popular <a href="https://www.mysql.com/">MySQL</a> Relational DBMS, but Sequelize provides support for many relational databases, such as PostgreSQL, MySQL, Microsoft SQL Server, SQLite, and MariaDB. The procedure we walk through in this chapter will be the same for any database supported by Sequelize. You'll simply need to install the associated client API libraries for your selected database.<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save @nestjs/sequelize sequelize sequelize-typescript mysql2
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev @types/sequelize</code></pre><p>Once the installation process is complete, we can import the <code>SequelizeModule</code> into the root <code>AppModule</code>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SequelizeModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/sequelize'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">SequelizeModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      dialect<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
      host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
      port<span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
      username<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
      database<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
      models<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>The <code>forRoot()</code> method supports all the configuration properties exposed by the Sequelize constructor (<a href="https://sequelize.org/v5/manual/getting-started.html#setting-up-a-connection">read more</a>). In addition, there are several extra configuration properties described below.<table><tr><td><code>retryAttempts</code><td>Number of attempts to connect to the database (default: <code>10</code>)<tr><td><code>retryDelay</code><td>Delay between connection retry attempts (ms) (default: <code>3000</code>)<tr><td><code>autoLoadModels</code><td>If <code>true</code>, models will be loaded automatically (default: <code>false</code>)<tr><td><code>keepConnectionAlive</code><td>If <code>true</code>, connection will not be closed on the application shutdown (default: <code>false</code>)<tr><td><code>synchronize</code><td>If <code>true</code>, automatically loaded models will be synchronized (default: <code>true</code>)</table><p>Once this is done, the <code>Sequelize</code> object will be available to inject across the entire project (without needing to import any modules), for example:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">service</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Sequelize</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'sequelize-typescript'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> sequelize<span class="token operator">:</span> <span class="token maybe-class-name">Sequelize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Sequelize</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'sequelize-typescript'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Sequelize</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>sequelize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">sequelize</span> <span class="token operator">=</span> sequelize<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><section id="models"class="level4"><h4>Models</h4><p>Sequelize implements the Active Record pattern. With this pattern, you use model classes directly to interact with the database. To continue the example, we need at least one model. Let's define the <code>User</code> model.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token property-access">model</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Column</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Model</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Table</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'sequelize-typescript'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Table</span></span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">User</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">Model</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span>
  firstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span>
  lastName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> defaultValue<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  isActive<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> Learn more about the available decorators <a href="https://github.com/RobinBuschmann/sequelize-typescript#column">here</a>.</blockquote><p>The <code>User</code> model file sits in the <code>users</code> directory. This directory contains all files related to the <code>UsersModule</code>. You can decide where to keep your model files, however, we recommend creating them near their <strong>domain</strong>, in the corresponding module directory.<p>To begin using the <code>User</code> model, we need to let Sequelize know about it by inserting it into the <code>models</code> array in the module <code>forRoot()</code> method options:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SequelizeModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/sequelize'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users/user.model'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">SequelizeModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      dialect<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
      host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
      port<span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
      username<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
      database<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
      models<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">User</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Next, let's look at the <code>UsersModule</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SequelizeModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/sequelize'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.model'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">SequelizeModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token maybe-class-name">User</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>This module uses the <code>forFeature()</code> method to define which models are registered in the current scope. With that in place, we can inject the <code>UserModel</code> into the <code>UsersService</code> using the <code>@InjectModel()</code> decorator:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token property-access">service</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">InjectModel</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/sequelize'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.model'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectModel</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">User</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> userModel<span class="token operator">:</span> <span class="token keyword">typeof</span> <span class="token maybe-class-name">User</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">User</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">userModel</span><span class="token punctuation">.</span><span class="token method function property-access">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">User</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">userModel</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      where<span class="token operator">:</span> <span class="token punctuation">{</span>
        id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> user<span class="token punctuation">.</span><span class="token method function property-access">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Dependencies</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getModelToken <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/sequelize'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.model'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token function">getModelToken</span><span class="token punctuation">(</span><span class="token maybe-class-name">User</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>usersRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersRepository</span> <span class="token operator">=</span> usersRepository<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">userModel</span><span class="token punctuation">.</span><span class="token method function property-access">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">userModel</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      where<span class="token operator">:</span> <span class="token punctuation">{</span>
        id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> user<span class="token punctuation">.</span><span class="token method function property-access">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>warning <strong>Notice</strong> Don't forget to import the <code>UsersModule</code> into the root <code>AppModule</code>.</blockquote><p>If you want to use the repository outside of the module which imports <code>SequelizeModule.forFeature</code>, you'll need to re-export the providers generated by it. You can do this by exporting the whole module, like this:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SequelizeModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/sequelize'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">SequelizeModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token maybe-class-name">User</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">SequelizeModule</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Now if we import <code>UsersModule</code> in <code>UserHttpModule</code>, we can use <code>@InjectModel(User)</code> in the providers of the latter module.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>users<span class="token operator">-</span>http<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.controller'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersController</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UserHttpModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="relations-1"class="level4"><h4>Relations</h4><p>Relations are associations established between two or more tables. Relations are based on common fields from each table, often involving primary and foreign keys.<p>There are three types of relations:<table><tr><td><code>One-to-one</code><td>Every row in the primary table has one and only one associated row in the foreign table<tr><td><code>One-to-many / Many-to-one</code><td>Every row in the primary table has one or more related rows in the foreign table<tr><td><code>Many-to-many</code><td>Every row in the primary table has many related rows in the foreign table, and every record in the foreign table has many related rows in the primary table</table><p>To define relations in entities, use the corresponding <strong>decorators</strong>. For example, to define that each <code>User</code> can have multiple photos, use the <code>@HasMany()</code> decorator.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token property-access">entity</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Column</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Model</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Table</span><span class="token punctuation">,</span> <span class="token maybe-class-name">HasMany</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'sequelize-typescript'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Photo</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../photos/photo.model'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Table</span></span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">User</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">Model</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span>
  firstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span>
  lastName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> defaultValue<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  isActive<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">HasMany</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Photo</span><span class="token punctuation">)</span>
  photos<span class="token operator">:</span> <span class="token maybe-class-name">Photo</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> To learn more about associations in Sequelize, read <a href="https://github.com/RobinBuschmann/sequelize-typescript#model-association">this</a> chapter.</blockquote></section><section id="auto-load-models"class="level4"><h4>Auto-load models</h4><p>Manually adding models to the <code>models</code> array of the connection options can be tedious. In addition, referencing models from the root module breaks application domain boundaries and causes leaking implementation details to other parts of the application. To solve this issue, automatically load models by setting both <code>autoLoadModels</code> and <code>synchronize</code> properties of the configuration object (passed into the <code>forRoot()</code> method) to <code>true</code>, as shown below:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SequelizeModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/sequelize'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">SequelizeModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>
      autoLoadModels<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      synchronize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>With that option specified, every model registered through the <code>forFeature()</code> method will be automatically added to the <code>models</code> array of the configuration object.<blockquote><p>warning <strong>Warning</strong> Note that models that aren't registered through the <code>forFeature()</code> method, but are only referenced from the model (via an association), won't be included.</blockquote></section><section id="sequelize-transactions"class="level4"><h4>Sequelize Transactions</h4><p>A database transaction symbolizes a unit of work performed within a database management system against a database, and treated in a coherent and reliable way independent of other transactions. A transaction generally represents any change in a database (<a href="https://en.wikipedia.org/wiki/Database_transaction">learn more</a>).<p>There are many different strategies to handle <a href="https://sequelize.org/v5/manual/transactions.html">Sequelize transactions</a>. Below is a sample implementation of a managed transaction (auto-callback).<p>First, we need to inject the <code>Sequelize</code> object into a class in the normal way:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> sequelize<span class="token operator">:</span> <span class="token maybe-class-name">Sequelize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>Sequelize</code> class is imported from the <code>sequelize-typescript</code> package.</blockquote><p>Now, we can use this object to create a transaction.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">async</span> <span class="token function">createMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">sequelize</span><span class="token punctuation">.</span><span class="token method function property-access">transaction</span><span class="token punctuation">(</span><span class="token keyword">async</span> t <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> transactionHost <span class="token operator">=</span> <span class="token punctuation">{</span> transaction<span class="token operator">:</span> t <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">userModel</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>
          <span class="token punctuation">{</span> firstName<span class="token operator">:</span> <span class="token string">'Abraham'</span><span class="token punctuation">,</span> lastName<span class="token operator">:</span> <span class="token string">'Lincoln'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          transactionHost<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">userModel</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>
          <span class="token punctuation">{</span> firstName<span class="token operator">:</span> <span class="token string">'John'</span><span class="token punctuation">,</span> lastName<span class="token operator">:</span> <span class="token string">'Boothe'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          transactionHost<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Transaction has been rolled back</span>
    <span class="token comment">// err is whatever rejected the promise chain returned to the transaction callback</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> Note that the <code>Sequelize</code> instance is used only to start the transaction. However, to test this class would require mocking the entire <code>Sequelize</code> object (which exposes several methods). Thus, we recommend using a helper factory class (e.g., <code>TransactionRunner</code>) and defining an interface with a limited set of methods required to maintain transactions. This technique makes mocking these methods pretty straightforward.</blockquote></section><section id="migrations-1"class="level4"><h4>Migrations</h4><p><a href="https://sequelize.org/v5/manual/migrations.html">Migrations</a> provide a way to incrementally update the database schema to keep it in sync with the application's data model while preserving existing data in the database. To generate, run, and revert migrations, Sequelize provides a dedicated <a href="https://sequelize.org/v5/manual/migrations.html#the-cli">CLI</a>.<p>Migration classes are separate from the Nest application source code. Their lifecycle is maintained by the Sequelize CLI. Therefore, you are not able to leverage dependency injection and other Nest specific features with migrations. To learn more about migrations, follow the guide in the <a href="https://sequelize.org/v5/manual/migrations.html#the-cli">Sequelize documentation</a>.<p><app-banner-courses></app-banner-courses></section><section id="multiple-databases-1"class="level4"><h4>Multiple databases</h4><p>Some projects require multiple database connections. This can also be achieved with this module. To work with multiple connections, first create the connections. In this case, connection naming becomes <strong>mandatory</strong>.<p>Suppose you have an <code>Album</code> entity stored in its own database.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> defaultOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  dialect<span class="token operator">:</span> <span class="token string">'postgres'</span><span class="token punctuation">,</span>
  port<span class="token operator">:</span> <span class="token number">5432</span><span class="token punctuation">,</span>
  username<span class="token operator">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span>
  database<span class="token operator">:</span> <span class="token string">'db'</span><span class="token punctuation">,</span>
  synchronize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">SequelizeModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>defaultOptions<span class="token punctuation">,</span>
      host<span class="token operator">:</span> <span class="token string">'user_db_host'</span><span class="token punctuation">,</span>
      models<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">User</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">SequelizeModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>defaultOptions<span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">'albumsConnection'</span><span class="token punctuation">,</span>
      host<span class="token operator">:</span> <span class="token string">'album_db_host'</span><span class="token punctuation">,</span>
      models<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">Album</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><blockquote><p>warning <strong>Notice</strong> If you don't set the <code>name</code> for a connection, its name is set to <code>default</code>. Please note that you shouldn't have multiple connections without a name, or with the same name, otherwise they will get overridden.</blockquote><p>At this point, you have <code>User</code> and <code>Album</code> models registered with their own connection. With this setup, you have to tell the <code>SequelizeModule.forFeature()</code> method and the <code>@InjectModel()</code> decorator which connection should be used. If you do not pass any connection name, the <code>default</code> connection is used.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">SequelizeModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token maybe-class-name">User</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">SequelizeModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token maybe-class-name">Album</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'albumsConnection'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>You can also inject the <code>Sequelize</code> instance for a given connection:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AlbumsService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectDataSource</span></span><span class="token punctuation">(</span><span class="token string">'albumsConnection'</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> sequelize<span class="token operator">:</span> <span class="token maybe-class-name">Sequelize</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>It's also possible to inject any <code>Sequelize</code> instance to the providers:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      provide<span class="token operator">:</span> <span class="token maybe-class-name">AlbumsService</span><span class="token punctuation">,</span>
      <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>albumsSequelize<span class="token operator">:</span> <span class="token maybe-class-name">Sequelize</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">AlbumsService</span></span><span class="token punctuation">(</span>albumsSequelize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">getDataSourceToken</span><span class="token punctuation">(</span><span class="token string">'albumsConnection'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AlbumsModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="testing-1"class="level4"><h4>Testing</h4><p>When it comes to unit testing an application, we usually want to avoid making a database connection, keeping our test suites independent and their execution process as fast as possible. But our classes might depend on models that are pulled from the connection instance. How do we handle that? The solution is to create mock models. In order to achieve that, we set up <a href="/fundamentals/custom-providers">custom providers</a>. Each registered model is automatically represented by a <code>&#x3C;ModelName>Model</code> token, where <code>ModelName</code> is the name of your model class.<p>The <code>@nestjs/sequelize</code> package exposes the <code>getModelToken()</code> function which returns a prepared token based on a given model.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">UsersService</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      provide<span class="token operator">:</span> <span class="token function">getModelToken</span><span class="token punctuation">(</span><span class="token maybe-class-name">User</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      useValue<span class="token operator">:</span> mockModel<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Now a substitute <code>mockModel</code> will be used as the <code>UserModel</code>. Whenever any class asks for <code>UserModel</code> using an <code>@InjectModel()</code> decorator, Nest will use the registered <code>mockModel</code> object.</section><section id="async-configuration-1"class="level4"><h4>Async configuration</h4><p>You may want to pass your <code>SequelizeModule</code> options asynchronously instead of statically. In this case, use the <code>forRootAsync()</code> method, which provides several ways to deal with async configuration.<p>One approach is to use a factory function:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">SequelizeModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    dialect<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
    username<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    password<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    database<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
    models<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Our factory behaves like any other <a href="https://docs.nestjs.com/fundamentals/async-providers">asynchronous provider</a> (e.g., it can be <code>async</code> and it's able to inject dependencies through <code>inject</code>).<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">SequelizeModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>configService<span class="token operator">:</span> <span class="token maybe-class-name">ConfigService</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    dialect<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    host<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'HOST'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token operator">+</span>configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'PORT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    username<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'USERNAME'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    password<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'PASSWORD'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    database<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'DATABASE'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    models<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Alternatively, you can use the <code>useClass</code> syntax:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">SequelizeModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  useClass<span class="token operator">:</span> <span class="token maybe-class-name">SequelizeConfigService</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The construction above will instantiate <code>SequelizeConfigService</code> inside <code>SequelizeModule</code> and use it to provide an options object by calling <code>createSequelizeOptions()</code>. Note that this means that the <code>SequelizeConfigService</code> has to implement the <code>SequelizeOptionsFactory</code> interface, as shown below:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">SequelizeConfigService</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">SequelizeOptionsFactory</span></span> <span class="token punctuation">{</span>
  <span class="token function">createSequelizeOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">SequelizeModuleOptions</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      dialect<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
      host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
      port<span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
      username<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
      database<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
      models<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>In order to prevent the creation of <code>SequelizeConfigService</code> inside <code>SequelizeModule</code> and use a provider imported from a different module, you can use the <code>useExisting</code> syntax.<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">SequelizeModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  useExisting<span class="token operator">:</span> <span class="token maybe-class-name">ConfigService</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This construction works the same as <code>useClass</code> with one critical difference - <code>SequelizeModule</code> will lookup imported modules to reuse an existing <code>ConfigService</code> instead of instantiating a new one.</section><section id="example-1"class="level4"><h4>Example</h4><p>A working example is available <a href="https://github.com/nestjs/nest/tree/master/sample/07-sequelize">here</a>. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>