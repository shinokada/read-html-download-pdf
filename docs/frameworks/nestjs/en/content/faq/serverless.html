<!doctype html><html lang="en"><meta charset="utf-8"><title>Serverless</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="serverless"class="level3"><h3>Serverless</h3><p>Serverless computing is a cloud computing execution model in which the cloud provider allocates machine resources on-demand, taking care of the servers on behalf of their customers. When an app is not in use, there are no computing resources allocated to the app. Pricing is based on the actual amount of resources consumed by an application (<a href="https://en.wikipedia.org/wiki/Serverless_computing">source</a>).<p>With a <strong>serverless architecture</strong>, you focus purely on the individual functions in your application code. Services such as AWS Lambda, Google Cloud Functions, and Microsoft Azure Functions take care of all the physical hardware, virtual machine operating system, and web server software management.<blockquote><p>info <strong>Hint</strong> This chapter does not cover the pros and cons of serverless functions nor dives into the specifics of any cloud providers.</blockquote><section id="cold-start"class="level4"><h4>Cold start</h4><p>A cold start is the first time your code has been executed in a while. Depending on a cloud provider you use, it may span several different operations, from downloading the code and bootstrapping the runtime to eventually running your code. This process adds <strong>significant latency</strong> depending on several factors, the language, the number of packages your application require, etc.<p>The cold start is important and although there are things which are beyond our control, there's still a lot of things we can do on our side to make it as short as possible.<p>While you can think of Nest as a fully-fledged framework designed to be used in complex, enterprise applications, it is also <strong>suitable for much "simpler" applications</strong> (or scripts). For example, with the use of <a href="/standalone-applications">Standalone applications</a> feature, you can take advantage of Nest's DI system in simple workers, CRON jobs, CLIs, or serverless functions.</section><section id="benchmarks"class="level4"><h4>Benchmarks</h4><p>To better understand what's the cost of using Nest or other, well-known libraries (like <code>express</code>) in the context of serverless functions, let's compare how much time Node runtime needs to run the following scripts:<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// #1 Express</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> express</span> <span class="token keyword module">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token arrow operator">=></span> res<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'Hello world!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token arrow operator">=></span> app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// #2 Nest (with @nestjs/platform-express)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">NestFactory</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> logger<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// #3 Nest as a Standalone application (no HTTP server)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">NestFactory</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createApplicationContext</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    logger<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppService</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// #4 Raw Node.js script</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Hello world!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>For all these scripts, we used the <code>tsc</code> (TypeScript) compiler and so the code remains unbundled (<code>webpack</code> isn't used).<table><thead><tr><th><th><tbody><tr><td>Express<td>0.0079s (7.9ms)<tr><td>Nest with <code>@nestjs/platform-express</code><td>0.1974s (197.4ms)<tr><td>Nest (standalone application)<td>0.1117s (111.7ms)<tr><td>Raw Node.js script<td>0.0071s (7.1ms)</table><blockquote><p>info <strong>Note</strong> Machine: MacBook Pro Mid 2014, 2.5 GHz Quad-Core Intel Core i7, 16 GB 1600 MHz DDR3, SSD.</blockquote><p>Now, let's repeat all benchmarks but this time, using <code>webpack</code> (if you have <a href="/cli/overview">Nest CLI</a> installed, you can run <code>nest build --webpack</code>) to bundle our application into a single executable JavaScript file. However, instead of using the default <code>webpack</code> configuration that Nest CLI ships with, we'll make sure to bundle all dependencies (<code>node_modules</code>) together, as follows:<pre class="language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> webpack</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> lazyImports <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'@nestjs/microservices/microservices-module'</span><span class="token punctuation">,</span>
    <span class="token string">'@nestjs/websockets/socket-module'</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token spread operator">...</span>options<span class="token punctuation">,</span>
    <span class="token literal-property property">externals</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token spread operator">...</span>options<span class="token punctuation">.</span><span class="token property-access">plugins</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>IgnorePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token function">checkResource</span><span class="token punctuation">(</span><span class="token parameter">resource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>lazyImports<span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
              require<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword control-flow">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> To instruct Nest CLI to use this configuration, create a new <code>webpack.config.js</code> file in the root directory of your project.</blockquote><p>With this configuration, we received the following results:<table><thead><tr><th><th><tbody><tr><td>Express<td>0.0068s (6.8ms)<tr><td>Nest with <code>@nestjs/platform-express</code><td>0.0815s (81.5ms)<tr><td>Nest (standalone application)<td>0.0319s (31.9ms)<tr><td>Raw Node.js script<td>0.0066s (6.6ms)</table><blockquote><p>info <strong>Note</strong> Machine: MacBook Pro Mid 2014, 2.5 GHz Quad-Core Intel Core i7, 16 GB 1600 MHz DDR3, SSD.</blockquote><blockquote><p>info <strong>Hint</strong> You could optimize it even further by applying additional code minification &#x26; optimization techniques (using <code>webpack</code> plugins, etc.).</blockquote><p>As you can see, the way you compile (and whether you bundle your code) is crucial and has a significant impact on the overall startup time. With <code>webpack</code>, you can get the bootstrap time of a standalone Nest application (starter project with one module, controller, and service) down to ~32ms on average, and down to ~81.5ms for a regular HTTP, express-based NestJS app.<p>For more complicated Nest applications, for example, with 10 resources (generated through <code>$ nest g resource</code> schematic = 10 modules, 10 controllers, 10 services, 20 DTO classes, 50 HTTP endpoints + <code>AppModule</code>), the overall startup on MacBook Pro Mid 2014, 2.5 GHz Quad-Core Intel Core i7, 16 GB 1600 MHz DDR3, SSD is approximately 0.1298s (129.8ms). Running a monolithic application as a serverless function typically doesn't make too much sense anyway, so think of this benchmark more as an example of how the bootstrap time may potentially increase as your application grows.</section><section id="runtime-optimizations"class="level4"><h4>Runtime optimizations</h4><p>Thus far we covered compile-time optimizations. These are unrelated to the way you define providers and load Nest modules in your application, and that plays an essential role as your application gets bigger.<p>For example, imagine having a database connection defined as an <a href="/fundamentals/async-providers">asynchronous provider</a>. Async providers are designed to delay the application start until one or more asynchronous tasks are completed. That means, if your serverless function on average requires 2s to connect to the database (on bootstrap), your endpoint will need at least two extra seconds (because it must wait till the connection is established) to send a response back (when it's a cold start and your application wasn't running already).<p>As you can see, the way you structure your providers is somewhat different in a <strong>serverless environment</strong> where bootstrap time is important. Another good example is if you use Redis for caching, but only in certain scenarios. Perhaps, in this case, you should not define a Redis connection as an async provider, as it would slow down the bootstrap time, even if it's not required for this specific function invocation.<p>Also, sometimes you could lazy-load entire modules, using the <code>LazyModuleLoader</code> class, as described in <a href="/fundamentals/lazy-loading-modules">this chapter</a>. Caching is a great example here too. Imagine that your application has, let's say, <code>CacheModule</code> which internally connects to Redis and also, exports the <code>CacheService</code> to interact with the Redis storage. If you don't need it for all potential function invocations, you can just load it on-demand, lazily. This way you'll get a faster startup time (when a cold start occurs) for all invocations that don't require caching.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token property-access">method</span> <span class="token operator">===</span> <span class="token maybe-class-name">RequestMethod</span><span class="token punctuation">[</span><span class="token maybe-class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">CacheModule</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./cache.module'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> moduleRef <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">lazyModuleLoader</span><span class="token punctuation">.</span><span class="token method function property-access">load</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">CacheModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">CacheService</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./cache.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> cacheService <span class="token operator">=</span> moduleRef<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token maybe-class-name">CacheService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> cacheService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token constant">ENDPOINT_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Another great example is a webhook or worker, which depending on some specific conditions (e.g., input arguments), may perform different operations. In such a case, you could specify a condition inside your route handler that lazily loads an appropriate module for the specific function invocation, and just load every other module lazily.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>workerType <span class="token operator">===</span> <span class="token maybe-class-name">WorkerType</span><span class="token punctuation">.</span><span class="token constant">A</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">WorkerAModule</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./worker-a.module'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> moduleRef <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">lazyModuleLoader</span><span class="token punctuation">.</span><span class="token method function property-access">load</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">WorkerAModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>workerType <span class="token operator">===</span> <span class="token maybe-class-name">WorkerType</span><span class="token punctuation">.</span><span class="token constant">B</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">WorkerBModule</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./worker-b.module'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> moduleRef <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">lazyModuleLoader</span><span class="token punctuation">.</span><span class="token method function property-access">load</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">WorkerBModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></section><section id="example-integration"class="level4"><h4>Example integration</h4><p>The way your application's entry file (typically <code>main.ts</code> file) is supposed to look like <strong>depends on several factors</strong> and so <strong>there's no single template</strong> that just works for every scenario. For example, the initialization file required to spin up your serverless function varies by cloud providers (AWS, Azure, GCP, etc.). Also, depending on whether you want to run a typical HTTP application with multiple routes/endpoints or just provide a single route (or execute a specific portion of code), your application's code will look different (for example, for the endpoint-per-function approach you could use the <code>NestFactory.createApplicationContext</code> instead of booting the HTTP server, setting up middleware, etc.).<p>Just for illustration purposes, we'll integrate Nest (using <code>@nestjs/platform-express</code> and so spinning up the whole, fully functional HTTP router) with the <a href="https://www.serverless.com/">Serverless</a> framework (in this case, targetting AWS Lambda). As we've mentioned earlier, your code will differ depending on the cloud provider you choose, and many other factors.<p>First, let's install the required packages:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i @vendia/serverless-express aws-lambda
$ <span class="token function">npm</span> i -D @types/aws-lambda serverless-offline</code></pre><blockquote><p>info <strong>Hint</strong> To speed up development cycles, we install the <code>serverless-offline</code> plugin which emulates AWS Î» and API Gateway.</blockquote><p>Once the installation process is complete, let's create the <code>serverless.yml</code> file to configure the Serverless framework:<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">service</span><span class="token punctuation">:</span> serverless<span class="token punctuation">-</span>example

<span class="token key atrule">plugins</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> serverless<span class="token punctuation">-</span>offline

<span class="token key atrule">provider</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> aws
  <span class="token key atrule">runtime</span><span class="token punctuation">:</span> nodejs14.x

<span class="token key atrule">functions</span><span class="token punctuation">:</span>
  <span class="token key atrule">main</span><span class="token punctuation">:</span>
    <span class="token key atrule">handler</span><span class="token punctuation">:</span> dist/main.handler
    <span class="token key atrule">events</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">http</span><span class="token punctuation">:</span>
          <span class="token key atrule">method</span><span class="token punctuation">:</span> ANY
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /
      <span class="token punctuation">-</span> <span class="token key atrule">http</span><span class="token punctuation">:</span>
          <span class="token key atrule">method</span><span class="token punctuation">:</span> ANY
          <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">'{proxy+}'</span></code></pre><blockquote><p>info <strong>Hint</strong> To learn more about the Serverless framework, visit the <a href="https://www.serverless.com/framework/docs/">official documentation</a>.</blockquote><p>With this place, we can now navigate to the <code>main.ts</code> file and update our bootstrap code with the required boilerplate:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">NestFactory</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports">serverlessExpress</span> <span class="token keyword module">from</span> <span class="token string">'@vendia/serverless-express'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Callback</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Context</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Handler</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'aws-lambda'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> server<span class="token operator">:</span> <span class="token maybe-class-name">Handler</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Handler</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> expressApp <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token method function property-access">getHttpAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token function">serverlessExpress</span><span class="token punctuation">(</span><span class="token punctuation">{</span> app<span class="token operator">:</span> expressApp <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> handler<span class="token operator">:</span> <span class="token function-variable function"><span class="token maybe-class-name">Handler</span></span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>
  event<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  context<span class="token operator">:</span> <span class="token maybe-class-name">Context</span><span class="token punctuation">,</span>
  callback<span class="token operator">:</span> <span class="token maybe-class-name">Callback</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  server <span class="token operator">=</span> server <span class="token operator">??</span> <span class="token punctuation">(</span><span class="token keyword control-flow">await</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token function">server</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> For creating multiple serverless functions and sharing common modules between them, we recommend using the <a href="/cli/monorepo#monorepo-mode">CLI Monorepo mode</a>.</blockquote><blockquote><p>warning <strong>Warning</strong> If you use <code>@nestjs/swagger</code> package, there are a few additional steps required to make it work properly in the context of serverless function. Check out this <a href="https://javascript.plainenglish.io/serverless-nestjs-document-your-api-with-swagger-and-aws-api-gateway-64a53962e8a2">article</a> for more information.</blockquote><p>Next, open up the <code>tsconfig.json</code> file and make sure to enable the <code>esModuleInterop</code> option to make the <code>@vendia/serverless-express</code> package load properly.<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    ...
    <span class="token property">"esModuleInterop"</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Now we can build our application (with <code>nest build</code> or <code>tsc</code>) and use the <code>serverless</code> CLI to start our lambda function locally:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> run build
$ npx serverless offline</code></pre><p>Once the application is running, open your browser and navigate to <code>http://localhost:3000/dev/[ANY_ROUTE]</code> (where <code>[ANY_ROUTE]</code> is any endpoint registered in your application).<p>In the sections above, we've shown that using <code>webpack</code> and bundling your app can have significant impact on the overall bootstrap time. However, to make it work with our example, there are a few additional configurations you must add in your <code>webpack.config.js</code> file. Generally, to make sure our <code>handler</code> function will be picked up, we must change the <code>output.libraryTarget</code> property to <code>commonjs2</code>.<pre class="language-javascript"><code class="language-javascript"><span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
  <span class="token spread operator">...</span>options<span class="token punctuation">,</span>
  <span class="token literal-property property">externals</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token spread operator">...</span>options<span class="token punctuation">.</span><span class="token property-access">output</span><span class="token punctuation">,</span>
    <span class="token literal-property property">libraryTarget</span><span class="token operator">:</span> <span class="token string">'commonjs2'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ... the rest of the configuration</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>With this in place, you can now use <code>$ nest build --webpack</code> to compile your function's code (and then <code>$ npx serverless offline</code> to test it).<p>It's also recommended (but <strong>not required</strong> as it will slow down your build process) to install the <code>terser-webpack-plugin</code> package and override its configuration to keep classnames intact when minifying your production build. Not doing so can result in incorrect behavior when using <code>class-validator</code> within your application.<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token maybe-class-name">TerserPlugin</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'terser-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
  <span class="token spread operator">...</span>options<span class="token punctuation">,</span>
  <span class="token literal-property property">externals</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">minimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">terserOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">keep_classnames</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token spread operator">...</span>options<span class="token punctuation">.</span><span class="token property-access">output</span><span class="token punctuation">,</span>
    <span class="token literal-property property">libraryTarget</span><span class="token operator">:</span> <span class="token string">'commonjs2'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ... the rest of the configuration</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></section><section id="using-standalone-application-feature"class="level4"><h4>Using standalone application feature</h4><p>Alternatively, if you want to keep your function very lightweight and you don't need any HTTP-related features (routing, but also guards, interceptors, pipes, etc.), you can just use <code>NestFactory.createApplicationContext</code> (as mentioned earlier) instead of running the entire HTTP server (and <code>express</code> under the hood), as follows:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">HttpStatus</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">NestFactory</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Callback</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Context</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Handler</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'aws-lambda'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> handler<span class="token operator">:</span> <span class="token function-variable function"><span class="token maybe-class-name">Handler</span></span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>
  event<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  context<span class="token operator">:</span> <span class="token maybe-class-name">Context</span><span class="token punctuation">,</span>
  callback<span class="token operator">:</span> <span class="token maybe-class-name">Callback</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> appContext <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createApplicationContext</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> appService <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    body<span class="token operator">:</span> appService<span class="token punctuation">.</span><span class="token method function property-access">getHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    statusCode<span class="token operator">:</span> <span class="token maybe-class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> Be aware that <code>NestFactory.createApplicationContext</code> does not wrap controller methods with enhancers (guard, interceptors, etc.). For this, you must use the <code>NestFactory.create</code> method.</blockquote><p>You could also pass the <code>event</code> object down to, let's say, <code>EventsService</code> provider that could process it and return a corresponding value (depending on the input value and your business logic).<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">const</span> handler<span class="token operator">:</span> <span class="token function-variable function"><span class="token maybe-class-name">Handler</span></span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>
  event<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  context<span class="token operator">:</span> <span class="token maybe-class-name">Context</span><span class="token punctuation">,</span>
  callback<span class="token operator">:</span> <span class="token maybe-class-name">Callback</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> appContext <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createApplicationContext</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> eventsService <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token maybe-class-name">EventsService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> eventsService<span class="token punctuation">.</span><span class="token method function property-access">process</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>